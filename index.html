<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Presenze 2050</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        html, body { overflow-x: hidden; width: 100%; position: relative; margin: 0; padding: 0; }

        body { font-family: 'Segoe UI', sans-serif; padding: 5px; background: #eef2f7; color: #333; }
        .header { text-align: center; margin-bottom: 10px; width: 100%; }
        
        /* LOGO OTTIMIZZATO */
        .logo { max-height: 80px; max-width: 90%; height: auto; border-radius: 10px; margin-bottom: 10px; }
        
        .controls-container { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; background: white; padding: 10px; border-radius: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); flex-wrap: wrap; align-items: center; }
        select, input { padding: 10px; border-radius: 10px; border: 2px solid #ddd; font-weight: 900; font-size: 1rem; color: #333; outline: none; }
        
        .actions-container { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; padding: 0 5px; width: 100%; }
        
        .btn-action { padding: 12px 15px; border-radius: 12px; border: none; font-weight: 900; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; font-size: 0.9rem; box-shadow: 0 4px 8px rgba(0,0,0,0.15); text-transform: uppercase; transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.92); }

        .btn-pdf { background: #e74c3c; } .btn-drive { background: #4285F4; } .btn-open-drive { background: #34a853; } .btn-admin { background: #6c757d; } 
        .btn-home { background: #ff9800; padding: 12px 20px; }
        .btn-oggi { background: #17a2b8; width: 45px; height: 45px; justify-content: center; font-size: 1.5rem; border-radius: 12px; }
        
        #admin-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; }
        #admin-panel { background: white; width: 95%; max-width: 500px; padding: 20px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); position: relative; max-height: 85vh; display: flex; flex-direction: column; }
        .close-admin { position: absolute; top: 15px; right: 15px; font-size: 2rem; cursor: pointer; color: #999; }
        
        .atleta-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 12px; margin-bottom: 8px; border: 1px solid #eee; }
        .atleta-name { font-weight: 900; color: #333; font-size: 0.9rem; }
        .atleta-cat { font-size: 0.7rem; color: #007bff; font-weight: bold; text-transform: uppercase; }

        .table-wrapper { overflow: auto; max-height: 65vh; border: 1px solid #ccc; border-radius: 10px; background: white; position: relative; -webkit-overflow-scrolling: touch; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        thead th.sticky-col { position: sticky; left: 0; top: 0; z-index: 20 !important; background: #343a40 !important; color: white !important; padding-left: 10px; font-size: 0.8rem; }
        thead th { position: sticky; top: 0; background: #343a40 !important; color: white !important; z-index: 10; padding: 8px; font-size: 0.65rem; border: 1px solid #454d55; text-align: center; }
        .sticky-col { position: sticky; left: 0; background: white !important; z-index: 11; border-right: 3px solid #007bff; min-width: 130px; padding: 10px; font-weight: 900; font-size: 0.85rem; }
        .day-cell { min-width: 45px; height: 45px; border: 1px solid #eee; text-align: center; cursor: pointer; font-weight: bold; font-size: 1.1rem; }
        .p-partecipa { background: #2ecc71 !important; color: white !important; }
        .today-cell { background: #d1ecf1; border: 2px solid #0c5460 !important; }
        .tot-cell { text-align: center; font-weight: 900; background: #f8f9fa; min-width: 40px; font-size: 0.9rem; border-left: 2px solid #ddd; }
        
        #status-auto { font-size: 0.9rem; color: #d35400; font-weight: 900; margin-bottom: 10px; background: #fff3cd; padding: 5px 12px; border-radius: 20px; display: inline-block; }

        /* MENU HOME OTTIMIZZATO */
        .menu-container { display: flex; flex-direction: column; gap: 10px; padding: 10px; width: 100%; }
        .btn-menu { width: 100%; padding: 30px 10px; font-weight: 900; font-size: 1.4rem; border-radius: 20px; color: white; border: none; cursor: pointer; text-transform: uppercase; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .btn-piccoli { background: #007bff; } .btn-grandi { background: #28a745; }
        .section-container { display: none; width: 100%; } .section-active { display: block; }
    </style>
</head>
<body>

    <div class="header">
        <img src="logo.png" alt="Logo" class="logo" onerror="this.src='https://via.placeholder.com/400x120?text=LOGO'">
        <div class="controls-container">
            <button class="btn-action btn-home" onclick="vaiAllaHome()">üè† HOME</button>
            <select id="select-mese" onchange="cambiaData()"></select>
            <select id="select-anno" onchange="cambiaData()"></select>
            <button class="btn-action btn-oggi" onclick="scrollOggi()">üéØ</button>
        </div>
        <div style="text-align:center;"><div id="status-auto">Sistema Pronto</div></div>
        <div class="actions-container">
            <button class="btn-action btn-pdf" onclick="scaricaPDFLocale()">üìÑ PDF</button>
            <button class="btn-action btn-drive" onclick="aggiornaBackupDrive()">‚òÅÔ∏è BACKUP</button>
            <button class="btn-action btn-open-drive" onclick="apriFileDrive()">üìÇ DRIVE</button>
            <button class="btn-action btn-admin" onclick="toggleAdmin()">‚öôÔ∏è ATLETI</button>
        </div>
    </div>

    <div id="admin-overlay">
        <div id="admin-panel">
            <span class="close-admin" onclick="toggleAdmin()">&times;</span>
            <h2 class="admin-title">üë§ Gestione Atleti</h2>
            <div style="background: #f0f4f8; padding: 15px; border-radius: 15px; margin-bottom: 20px;">
                <input type="text" id="new-nome" placeholder="NOME E COGNOME" style="width:100%; margin-bottom:10px; box-sizing: border-box; border: 2px solid #fff;">
                <select id="new-cat" style="width:100%; margin-bottom:15px; border: 2px solid #fff;">
                    <option value="GIOVANISSIMI">GIOVANISSIMI</option><option value="ESORDIENTI">ESORDIENTI</option>
                    <option value="R12">R12</option><option value="RAGAZZI">RAGAZZI</option><option value="ALLIEVI">ALLIEVI</option><option value="JUNIOR">JUNIOR</option><option value="SENIOR">SENIOR</option>
                </select>
                <button class="btn-action btn-open-drive" style="width:100%; justify-content:center; padding:15px;" onclick="aggiungiAtleta()">+ AGGIUNGI ORA</button>
            </div>
            <div id="lista-atleti-admin" style="overflow-y: auto; flex-grow: 1; padding-right: 5px;"></div>
        </div>
    </div>

    <div class="menu-container" id="main-menu">
        <button class="btn-menu btn-piccoli" onclick="mostraSezione('piccoli')">CATEGORIE PICCOLI</button>
        <button class="btn-menu btn-grandi" onclick="mostraSezione('grandi')">CATEGORIE GRANDI</button>
    </div>

    <div id="sez-piccoli" class="section-container">
        <div class="table-wrapper"><table id="tab-piccoli"><thead></thead><tbody></tbody></table></div>
    </div>
    <div id="sez-grandi" class="section-container">
        <div class="table-wrapper"><table id="tab-grandi"><thead></thead><tbody></tbody></table></div>
    </div>

<script>
    const SB_URL = 'https://jiktdsvwerqstrlthwxu.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imppa3Rkc3Z3ZXJxc3RybHRod3h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDkxMDEsImV4cCI6MjA4MzgyNTEwMX0.wmEnME6GaHXrvLoQH7MDijiTU4dZfoi9wOcrqs9fP10';
    const WEB_APP_DRIVE_URL = "https://script.google.com/macros/s/AKfycbwSDZTTurQjncmNAr7-bZNYMg6uxRewSf3tDTRuAICC2zMYFFpUZ9OGyex0LM8McHZ4/exec"; 

    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    let dataAttuale = new Date();
    let atletiCache = [], presenzeCache = [];
    let timerBackup = null;
    let secondiMancanti = 10;
    
    const nomiMesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
    const nomiGiorni = ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"];
    const CAT_PICCOLI = ['GIOVANISSIMI', 'ESORDIENTI'];
    const CAT_GRANDI = ['R12', 'RAGAZZI', 'ALLIEVI', 'JUNIOR', 'JUNIORES', 'SENIOR', 'ALLIEVE'];

    async function inizializza() {
        const m = localStorage.getItem('p_mese') || dataAttuale.getMonth();
        const a = localStorage.getItem('p_anno') || dataAttuale.getFullYear();
        dataAttuale = new Date(a, m, 1);
        popolaSelettori(m, a);
        await caricaDati();
        sottoscriviRealtime();
        const lastSez = sessionStorage.getItem('last_sez');
        if (lastSez) mostraSezione(lastSez);
    }

    function sottoscriviRealtime() {
        supabaseClient
            .channel('db-changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'presenze' }, async (payload) => {
                const { data: pres } = await supabaseClient.from('presenze').select('*')
                    .gte('data', `${dataAttuale.getFullYear()}-01-01`)
                    .lte('data', `${dataAttuale.getFullYear()}-12-31`);
                presenzeCache = pres || [];
                renderTabella();
            })
            .on('postgres_changes', { event: '*', schema: 'public', table: 'atleti' }, async () => {
                await caricaDati();
            })
            .subscribe();
    }

    function popolaSelettori(m, a) {
        const sm = document.getElementById('select-mese'), sa = document.getElementById('select-anno');
        nomiMesi.forEach((nome, i) => sm.add(new Option(nome, i)));
        for(let i=2025; i<=2050; i++) sa.add(new Option(i, i));
        sm.value = m; sa.value = a;
    }

    async function caricaDati() {
        const { data: atleti } = await supabaseClient.from('atleti').select('*').order('nome');
        atletiCache = atleti || [];
        const { data: presenze } = await supabaseClient.from('presenze').select('*')
            .gte('data', `${dataAttuale.getFullYear()}-01-01`)
            .lte('data', `${dataAttuale.getFullYear()}-12-31`);
        presenzeCache = presenze || [];
        renderTabella();
        renderAdminList();
    }

    function renderTabella() {
        const anno = dataAttuale.getFullYear(), mese = dataAttuale.getMonth();
        const giorniMese = new Date(anno, mese + 1, 0).getDate();
        const oggiStr = new Date().toLocaleDateString('en-CA');
        ["piccoli", "grandi"].forEach(tipo => {
            const table = document.getElementById(`tab-${tipo}`);
            let head = `<tr><th class="sticky-col">ATLETA</th>`;
            for(let i=1; i<=giorniMese; i++) head += `<th>${nomiGiorni[new Date(anno, mese, i).getDay()]}<br>${i}</th>`;
            head += `<th>TOT</th></tr>`;
            table.querySelector('thead').innerHTML = head;
            const cats = tipo === 'piccoli' ? CAT_PICCOLI : CAT_GRANDI;
            const filtrati = atletiCache.filter(a => cats.includes((a.categoria || "").trim().toUpperCase()));
            let body = "";
            filtrati.forEach(a => {
                body += `<tr><td class="sticky-col">${a.nome.toUpperCase()}</td>`;
                let totMese = 0;
                for(let i=1; i<=giorniMese; i++) {
                    const dStr = `${anno}-${String(mese+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const p = presenzeCache.find(x => x.atleta_id === a.id && x.data === dStr && x.stato === 'partecipa');
                    if(p) totMese++;
                    body += `<td class="day-cell ${p?'p-partecipa':''} ${dStr===oggiStr?'today-cell':''}" onclick="togglePresenza(this, ${a.id}, '${dStr}')">${p?'‚úî':''}</td>`;
                }
                body += `<td class="tot-cell">${totMese}</td></tr>`;
            });
            table.querySelector('tbody').innerHTML = body;
        });
    }

    async function togglePresenza(el, aId, data) {
        const isP = el.classList.contains('p-partecipa');
        const nuovoStato = isP ? 'non partecipa' : 'partecipa';
        el.classList.toggle('p-partecipa'); el.innerText = isP ? '' : '‚úî';
        const totCell = el.parentElement.querySelector('.tot-cell');
        totCell.innerText = parseInt(totCell.innerText) + (nuovoStato === 'partecipa' ? 1 : -1);
        await supabaseClient.from('presenze').upsert({ atleta_id: aId, data: data, stato: nuovoStato }, { onConflict: 'atleta_id, data' });
        const idx = presenzeCache.findIndex(x => x.atleta_id === aId && x.data === data);
        if (nuovoStato === 'partecipa') { if (idx > -1) presenzeCache[idx].stato = 'partecipa'; else presenzeCache.push({ atleta_id: aId, data: data, stato: 'partecipa' }); } else if (idx > -1) presenzeCache[idx].stato = 'non partecipa';
        avviaTimerBackup();
    }

    function avviaTimerBackup() {
        clearInterval(timerBackup); secondiMancanti = 10;
        const status = document.getElementById('status-auto');
        timerBackup = setInterval(() => { secondiMancanti--; status.innerText = `‚è≥ BACKUP IN ${secondiMancanti}s...`; if (secondiMancanti <= 0) { clearInterval(timerBackup); aggiornaBackupDrive(); } }, 1000);
    }

    async function aggiornaBackupDrive() {
        const status = document.getElementById('status-auto');
        status.innerText = "‚òÅÔ∏è GENERANDO PDF...";
        try {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('l', 'mm', 'a4'); const annoC = dataAttuale.getFullYear();
            for (let m = 0; m < 12; m++) {
                if (m > 0) doc.addPage();
                const g = new Date(annoC, m + 1, 0).getDate();
                const h = [["ATLETA", ...Array.from({length: g}, (_, i) => `${nomiGiorni[new Date(annoC, m, i + 1).getDay()]}\n${i + 1}`), "TOT"]];
                doc.setFontSize(14); doc.setTextColor(52, 58, 64); doc.text(`REGISTRO PRESENZE - ${nomiMesi[m].toUpperCase()} ${annoC}`, 14, 12);
                const colStyles = { 0: { halign: 'left', cellWidth: 32, fontStyle: 'bold', fillColor: [255, 255, 255] } };
                const larghezzaGiorno = (297 - 32 - 15 - 28) / g;
                for (let i = 1; i <= g; i++) colStyles[i] = { cellWidth: larghezzaGiorno };
                colStyles[g + 1] = { cellWidth: 10, fillColor: [248, 249, 250], fontStyle: 'bold' };
                const config = { head: h, startY: 18, theme: 'grid', styles: { fontSize: 5, cellPadding: 0.5, halign: 'center', lineColor: [221, 221, 221] }, headStyles: { fillColor: [52, 58, 64], textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 4.5 }, columnStyles: colStyles, didParseCell: function(data) { if (data.section === 'body' && data.column.index > 0 && data.column.index <= g && data.cell.text[0] === '‚úî') { data.cell.styles.fillColor = [46, 204, 113]; data.cell.styles.textColor = [255, 255, 255]; } } };
                doc.autoTable({...config, body: preparaDatiPDF(CAT_PICCOLI, annoC, m, g)});
                doc.autoTable({...config, body: preparaDatiPDF(CAT_GRANDI, annoC, m, g), startY: doc.lastAutoTable.finalY + 8});
            }
            const b64 = doc.output('datauristring').split(',')[1];
            status.innerText = "‚òÅÔ∏è SALVATAGGIO DRIVE...";
            const resp = await fetch(WEB_APP_DRIVE_URL, { method: 'POST', body: JSON.stringify({ nomeFile: `Registro_${annoC}.pdf`, blob: b64 }) });
            const res = await resp.json();
            if(res.fileUrl) { localStorage.setItem('ultimo_pdf_url', res.fileUrl); status.innerHTML = `‚úÖ BACKUP OK! <a href="${res.fileUrl}" target="_blank">APRI</a>`; }
        } catch(e) { status.innerText = "‚ùå ERRORE BACKUP"; console.error(e); }
    }

    function scaricaPDFLocale() { aggiornaBackupDrive(); }

    function preparaDatiPDF(cats, anno, mese, giorni) {
        return atletiCache.filter(a => cats.includes((a.categoria || "").trim().toUpperCase())).map(a => {
            let r = [a.nome.toUpperCase()], tot = 0;
            for(let d=1; d<=giorni; d++){
                let dStr = `${anno}-${String(mese+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                if(presenzeCache.find(x => x.atleta_id === a.id && x.data === dStr && x.stato === 'partecipa')){ r.push("‚úî"); tot++; } else r.push("");
            }
            r.push(tot); return r;
        });
    }

    function scrollOggi() {
        const active = document.querySelector('.section-active');
        if (!active) return;
        const target = active.querySelector('.today-cell');
        const wrapper = active.querySelector('.table-wrapper');
        const stickyWidth = active.querySelector('.sticky-col').offsetWidth; 
        if (target && wrapper) wrapper.scrollTo({ left: target.offsetLeft - stickyWidth, behavior: 'smooth' });
    }

    function mostraSezione(s) {
        sessionStorage.setItem('last_sez', s);
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('sez-piccoli').className = s === 'piccoli' ? 'section-active' : 'section-container';
        document.getElementById('sez-grandi').className = s === 'grandi' ? 'section-active' : 'section-container';
        setTimeout(scrollOggi, 300);
    }

    function vaiAllaHome() { sessionStorage.removeItem('last_sez'); location.reload(); }
    function cambiaData() { localStorage.setItem('p_mese', document.getElementById('select-mese').value); localStorage.setItem('p_anno', document.getElementById('select-anno').value); location.reload(); }
    
    function toggleAdmin() { 
        const ov = document.getElementById('admin-overlay');
        ov.style.display = ov.style.display === 'flex' ? 'none' : 'flex'; 
    }

    async function aggiungiAtleta() {
        const inputNome = document.getElementById('new-nome');
        const nome = inputNome.value.trim().toUpperCase();
        const cat = document.getElementById('new-cat').value;
        if(nome) {
            document.getElementById('status-auto').innerText = "‚è≥ AGGIUNGO...";
            await supabaseClient.from('atleti').insert([{ nome, categoria: cat }]);
            inputNome.value = ""; await caricaDati();
            document.getElementById('status-auto').innerText = "‚úÖ AGGIUNTO";
        }
    }

    function renderAdminList() {
        document.getElementById('lista-atleti-admin').innerHTML = atletiCache.map(a => `
            <div class="atleta-item">
                <div class="atleta-info">
                    <span class="atleta-name">${a.nome}</span>
                    <span class="atleta-cat">${a.categoria}</span>
                </div>
                <button class="btn-del" onclick="eliminaAtleta(${a.id})">ELIMINA</button>
            </div>
        `).join('');
    }

    async function eliminaAtleta(id) { 
        if(confirm("ELIMINARE DEFINITIVAMENTE?")) { 
            document.getElementById('status-auto').innerText = "‚è≥ ELIMINO...";
            await supabaseClient.from('atleti').delete().eq('id', id); 
            await caricaDati();
            document.getElementById('status-auto').innerText = "‚úÖ ELIMINATO";
        } 
    }

    function apriFileDrive() { const url = localStorage.getItem('ultimo_pdf_url'); if(url) window.open(url, '_blank'); else alert("Nessun backup trovato."); }
    window.onload = inizializza;
</script>
</body>
</html>
