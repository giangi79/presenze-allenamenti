<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Presenze 2050</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Presenze">
<link rel="apple-touch-icon" href="icon-192.png">

    <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#343a40">
<link rel="apple-touch-icon" href="icon-192.png">

<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js')
      .then(() => console.log("PWA pronta!"));
  }
</script>

    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        html, body { overflow-x: hidden; width: 100%; position: relative; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', sans-serif; padding: 5px; background: #eef2f7; color: #333; }
        .header { text-align: center; margin-bottom: 10px; width: 100%; }
        .logo { max-height: 120px; max-width: 95%; height: auto; border-radius: 10px; margin-bottom: 5px; }
        .controls-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 8px; background: white; padding: 8px; border-radius: 15px; box-shadow: 0 6px 15px rgba(0,0,0,0.08); flex-wrap: wrap; align-items: center; }
        select, input { padding: 8px; border-radius: 10px; border: 2px solid #ddd; font-weight: 900; font-size: 0.9rem; color: #333; outline: none; }
        .actions-container { display: flex; justify-content: center; gap: 6px; margin-bottom: 10px; flex-wrap: wrap; padding: 0 5px; width: 100%; }
        .btn-action { padding: 10px 12px; border-radius: 10px; border: none; font-weight: 900; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; font-size: 0.8rem; box-shadow: 0 4px 8px rgba(0,0,0,0.15); text-transform: uppercase; transition: transform 0.1s; }
        .btn-action:active { transform: scale(0.92); }
        .btn-drive { background: #4285F4; } .btn-open-drive { background: #34a853; } .btn-admin { background: #6c757d; } 
        .btn-home { background: #ff9800; padding: 10px 15px; }
        .btn-oggi { background: #17a2b8; width: 40px; height: 40px; justify-content: center; font-size: 1.2rem; border-radius: 10px; }
        .btn-backup-auto { background: #f39c12; } /* Arancione quando disabilitato */
        .btn-backup-auto.attivo { background: #2ecc71; } /* Verde quando attivo */
        .btn-numeric-input { background: #8e44ad; } /* Viola per input numerico */
        .btn-numeric-input.attivo { background: #9b59b6; } /* Viola pi√π chiaro quando attivo */
        
        #admin-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: center; }
        #admin-panel { background: white; width: 95%; max-width: 500px; padding: 20px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); position: relative; max-height: 85vh; display: flex; flex-direction: column; }
        .close-admin { position: absolute; top: 15px; right: 15px; font-size: 2rem; cursor: pointer; color: #999; }
        
        /* Animazioni Pulsanti Pannello Atleti */
        .atleta-item button { transition: all 0.2s ease; cursor: pointer; }
        .atleta-item button:hover { filter: brightness(1.1); }
        .atleta-item button:active { transform: scale(0.9); opacity: 0.8; }
        #btn-save-atleta { transition: all 0.2s ease; }
        #btn-save-atleta:hover { filter: brightness(1.05); }
        #btn-save-atleta:active { transform: scale(0.96); }

        .atleta-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 12px; margin-bottom: 8px; border: 1px solid #eee; }
        .atleta-item.archiviato { opacity: 0.6; background: #e9ecef; }
        .atleta-name { font-weight: 900; color: #333; font-size: 0.85rem; }
        .atleta-cat { font-size: 0.65rem; color: #007bff; font-weight: bold; text-transform: uppercase; }
        .table-wrapper { overflow: auto; max-height: 70vh; border: 1px solid #ccc; border-radius: 10px; background: white; position: relative; -webkit-overflow-scrolling: touch; touch-action: pan-x pan-y; }
        table { border-collapse: separate; border-spacing: 0; width: auto; min-width: 100%; }
        thead th.sticky-col { position: sticky; left: 0; top: 0; z-index: 25 !important; background: #343a40 !important; color: white !important; padding: 5px; font-size: 0.7rem; }
        thead th { position: sticky; top: 0; background: #343a40 !important; color: white !important; z-index: 10; padding: 5px; font-size: 0.65rem; border: 1px solid #454d55; text-align: center; }
        .sticky-col { position: sticky; left: 0; background: white !important; z-index: 11; border-right: 3px solid #007bff; min-width: 110px; max-width: 110px; padding: 8px 5px; font-weight: 900; font-size: 0.8rem; word-wrap: break-word; overflow-wrap: break-word; line-height: 1.1; text-align: left; }
        .day-cell { width: 46px; min-width: 46px; height: 46px; border: 1px solid #eee; text-align: center; cursor: pointer; font-weight: bold; font-size: 1.2rem; padding: 0; -webkit-tap-highlight-color: transparent; position: relative; }
        .p-partecipa { background: #2ecc71 !important; color: white !important; }
        .today-cell { background: #d1ecf1; border: 2px solid #0c5460 !important; }
        
        .tot-cell { position: sticky; right: 0; text-align: center; font-weight: 900; background: #f8f9fa !important; width: 46px; min-width: 46px; font-size: 0.9rem; border-left: 2px solid #ddd; z-index: 11; }
        thead th:last-child { position: sticky; right: 0; z-index: 25 !important; background: #343a40 !important; }

        #status-auto { font-size: 0.8rem; color: #d35400; font-weight: 900; margin-bottom: 8px; background: #fff3cd; padding: 4px 10px; border-radius: 20px; display: inline-block; }
        .menu-container { display: flex; flex-direction: column; gap: 10px; padding: 10px; width: 100%; }
        .btn-menu { width: 100%; padding: 25px 10px; font-weight: 900; font-size: 1.2rem; border-radius: 20px; color: white; border: none; cursor: pointer; text-transform: uppercase; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
        .btn-cuccioli { background: #e91e63; } .btn-piccoli { background: #007bff; } .btn-grandi { background: #28a745; }
        .section-container { display: none; width: 100%; } .section-active { display: block; }
        
        /* Stile per l'input numerico */
        .number-input-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .number-input-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            min-width: 250px;
        }
        .number-input {
            width: 100%;
            font-size: 2rem;
            text-align: center;
            border: 3px solid #2ecc71;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .input-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .input-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            color: white;
        }
        .input-btn.confirm {
            background: #2ecc71;
        }
        .input-btn.cancel {
            background: #e74c3c;
        }
        .input-btn.clear {
            background: #f39c12;
        }
        
        @media (min-width: 768px) { .sticky-col { min-width: 180px; max-width: 180px; font-size: 0.9rem; } .day-cell, .tot-cell { width: 50px; min-width: 50px; height: 50px; } }
    </style>
</head>
<body>

    <div class="header">
        <img src="logo.png" alt="Logo" class="logo" onerror="this.src='https://via.placeholder.com/400x120?text=LOGO'">
        <div class="controls-container">
            <button class="btn-action btn-home" onclick="vaiAllaHome()">üè†</button>
            <select id="select-mese" onchange="cambiaData()"></select>
            <select id="select-anno" onchange="cambiaData()"></select>
            <button class="btn-action btn-oggi" onclick="scrollOggi()">üéØ</button>
        </div>
        <div style="text-align:center;"><div id="status-auto">Sistema Pronto</div></div>
        <div class="actions-container">
            <button class="btn-action btn-drive" onclick="aggiornaBackupDrive()">‚òÅÔ∏è BACKUP</button>
            <button class="btn-action btn-open-drive" onclick="apriFileDrive()">üìÇ DRIVE</button>
            <!-- Pulsante per input numerico -->
            <button class="btn-action btn-numeric-input" onclick="toggleNumericInput()" id="btn-numeric-input">üî¢ NUM OFF</button>
            <!-- Pulsante per disattivare backup automatico -->
            <button class="btn-action btn-backup-auto attivo" onclick="toggleBackupAutomatico()" id="btn-backup-auto">‚ñ∂Ô∏è AUTO ON</button>
            <button class="btn-action btn-admin" onclick="toggleAdmin()">‚öôÔ∏è ATLETI</button>
        </div>
    </div>

    <div id="admin-overlay">
        <div id="admin-panel">
            <span class="close-admin" onclick="toggleAdmin()">&times;</span>
            <h2 class="admin-title">üë§ Gestione Atleti</h2>
            <div id="admin-form" style="background: #f0f4f8; padding: 15px; border-radius: 15px; margin-bottom: 20px;">
                <input type="hidden" id="edit-id">
                <input type="text" id="new-nome" placeholder="NOME E COGNOME" style="width:100%; margin-bottom:10px; box-sizing: border-box; border: 2px solid #fff;">
                <select id="new-cat" style="width:100%; margin-bottom:15px; border: 2px solid #fff;">
                    <option value="CUCCIOLI">CUCCIOLI</option>
                    <option value="GIOVANISSIMI">GIOVANISSIMI</option>
                    <option value="ESORDIENTI">ESORDIENTI</option>
                    <option value="R12">R12</option>
                    <option value="RAGAZZI">RAGAZZI</option>
                    <option value="ALLIEVI">ALLIEVI</option>
                    <option value="JUNIOR">JUNIOR</option>
                    <option value="SENIOR">SENIOR</option>
                </select>
                <button id="btn-save-atleta" class="btn-action btn-open-drive" style="width:100%; justify-content:center; padding:15px;" onclick="salvaAtleta()">+ AGGIUNGI ORA</button>
                <button id="btn-cancel-edit" style="display:none; width:100%; margin-top:5px; background:transparent; border:none; color:#666; font-size:0.7rem; cursor:pointer;" onclick="resetForm()">ANNULLA MODIFICA</button>
            </div>
            <div id="lista-atleti-admin" style="overflow-y: auto; flex-grow: 1; padding-right: 5px;"></div>
        </div>
    </div>

    <!-- Overlay per input numerico -->
    <div id="number-input-overlay" class="number-input-overlay" style="display: none;">
        <div class="number-input-container">
            <h3 style="margin-top:0;">Inserisci numero</h3>
            <input type="number" id="number-input" class="number-input" min="0" max="999" value="1">
            <div class="input-buttons">
                <button class="input-btn clear" onclick="clearNumberInput()">PULISCI</button>
                <button class="input-btn cancel" onclick="cancelNumberInput()">ANNULLA</button>
                <button class="input-btn confirm" onclick="confirmNumberInput()">OK</button>
            </div>
        </div>
    </div>

    <div class="menu-container" id="main-menu">
        <button class="btn-menu btn-cuccioli" onclick="mostraSezione('cuccioli')">CATEGORIE CUCCIOLI</button>
        <button class="btn-menu btn-piccoli" onclick="mostraSezione('piccoli')">CATEGORIE PICCOLI</button>
        <button class="btn-menu btn-grandi" onclick="mostraSezione('grandi')">CATEGORIE GRANDI</button>
    </div>

    <div id="sez-cuccioli" class="section-container">
        <div class="table-wrapper" onscroll="handleScroll()"><table id="tab-cuccioli"><thead></thead><tbody></tbody></table></div>
    </div>
    <div id="sez-piccoli" class="section-container">
        <div class="table-wrapper" onscroll="handleScroll()"><table id="tab-piccoli"><thead></thead><tbody></tbody></table></div>
    </div>
    <div id="sez-grandi" class="section-container">
        <div class="table-wrapper" onscroll="handleScroll()"><table id="tab-grandi"><thead></thead><tbody></tbody></table></div>
    </div>

<script>
    const SB_URL = 'https://jiktdsvwerqstrlthwxu.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imppa3Rkc3Z3ZXJxc3RybHRod3h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDkxMDEsImV4cCI6MjA4MzgyNTEwMX0.wmEnME6GaHXrvLoQH7MDijiTU4dZfoi9wOcrqs9fP10';
    const WEB_APP_DRIVE_URL = "https://script.google.com/macros/s/AKfycbx1mEyj7Ul-XjAS1EwIZybiHDc2ti1TLe9fY22nTpxK_W0eAgOWwcSEltvoerB6YuB8WQ/exec"; 

    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    let dataAttuale = new Date();
    let atletiCache = [], presenzeCache = [];
    let timerBackup = null;
    let secondiMancanti = 10;
    let isScrolling = false;
    let scrollTimeout;
    
    // Variabili per gestione long press
    let longPressTimer = null;
    let isLongPress = false;
    const LONG_PRESS_DURATION = 500; // 500ms per considerarlo un long press
    let currentCellData = null; // Memorizza i dati della cella corrente per l'input
    
    // Aggiungi questa variabile per gestione backup automatico
    let backupAutomaticoAttivo = true;
    
    // Variabile per gestione input numerico
    let numericInputAttivo = false;
    
    const nomiMesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
    const nomiGiorni = ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"];
    const CAT_CUCCIOLI = ['CUCCIOLI'];
    const CAT_PICCOLI = ['GIOVANISSIMI', 'ESORDIENTI'];
    const CAT_GRANDI = ['R12', 'RAGAZZI', 'ALLIEVI', 'JUNIOR', 'JUNIORES', 'SENIOR', 'ALLIEVE'];

    function handleScroll() {
        isScrolling = true;
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => { isScrolling = false; }, 150);
    }

    async function inizializza() {
        const m = localStorage.getItem('p_mese') || dataAttuale.getMonth();
        const a = localStorage.getItem('p_anno') || dataAttuale.getFullYear();
        dataAttuale = new Date(a, m, 1);
        popolaSelettori(m, a);
        await caricaDati();
        sottoscriviRealtime();
        const lastSez = sessionStorage.getItem('last_sez');
        if (lastSez) mostraSezione(lastSez);
        
        // Carica lo stato dell'input numerico
        caricaStatoNumericInput();
    }

    function sottoscriviRealtime() {
        supabaseClient.channel('db-changes').on('postgres_changes', { event: '*', schema: 'public', table: 'presenze' }, async () => {
            const { data: pres } = await supabaseClient.from('presenze').select('*').gte('data', `${dataAttuale.getFullYear()}-01-01`).lte('data', `${dataAttuale.getFullYear()}-12-31`);
            presenzeCache = pres || []; renderTabella();
        }).on('postgres_changes', { event: '*', schema: 'public', table: 'atleti' }, async () => { await caricaDati(); }).subscribe();
    }

    function popolaSelettori(m, a) {
        const sm = document.getElementById('select-mese'), sa = document.getElementById('select-anno');
        sm.innerHTML = ""; sa.innerHTML = "";
        nomiMesi.forEach((nome, i) => sm.add(new Option(nome, i)));
        for(let i=2025; i<=2050; i++) sa.add(new Option(i, i));
        sm.value = m; sa.value = a;
    }

    async function caricaDati() {
        const { data: atleti } = await supabaseClient.from('atleti').select('*').order('nome');
        atletiCache = atleti || [];
        const { data: presenze } = await supabaseClient.from('presenze').select('*').gte('data', `${dataAttuale.getFullYear()}-01-01`).lte('data', `${dataAttuale.getFullYear()}-12-31`);
        presenzeCache = presenze || [];
        renderTabella(); renderAdminList();
    }

    function renderTabella() {
        const anno = dataAttuale.getFullYear(), mese = dataAttuale.getMonth();
        const giorniMese = new Date(anno, mese + 1, 0).getDate();
        const oggiStr = new Date().toLocaleDateString('en-CA');
        ["cuccioli", "piccoli", "grandi"].forEach(tipo => {
            const table = document.getElementById(`tab-${tipo}`);
            let head = `<tr><th class="sticky-col">ATLETA</th>`;
            for(let i=1; i<=giorniMese; i++) head += `<th>${nomiGiorni[new Date(anno, mese, i).getDay()]}<br>${i}</th>`;
            head += `<th>TOT</th></tr>`;
            table.querySelector('thead').innerHTML = head;
            const cats = tipo === 'cuccioli' ? CAT_CUCCIOLI : (tipo === 'piccoli' ? CAT_PICCOLI : CAT_GRANDI);
            const filtrati = atletiCache.filter(a => cats.includes((a.categoria || "").trim().toUpperCase()) && (a.archiviato === false || a.archiviato === null));
            let body = "";
            filtrati.forEach(a => {
                body += `<tr><td class="sticky-col">${a.nome.toUpperCase()}</td>`;
                let totMese = 0;
                for(let i=1; i<=giorniMese; i++) {
                    const dStr = `${anno}-${String(mese+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const p = presenzeCache.find(x => x.atleta_id === a.id && x.data === dStr);
                    // Controlla se c'√® un numero salvato
                    const hasNumber = p && p.stato && p.stato.includes('numero:');
                    const numberValue = hasNumber ? p.stato.split(':')[1] : '';
                    
                    // Se c'√® un numero, la cella deve essere verde e mostrare il numero
                    const isGreen = p && (p.stato === 'partecipa' || hasNumber);
                    if(isGreen) totMese++;
                    
                    // Aggiunge event listener solo se l'input numerico √® attivo
                    const longPressAttrs = numericInputAttivo ? 
                        `onmousedown="startLongPress(this, ${a.id}, '${dStr}')" 
                         onmouseup="endLongPress(this, ${a.id}, '${dStr}')" 
                         onmouseleave="cancelLongPress()"
                         ontouchstart="startLongPress(this, ${a.id}, '${dStr}')" 
                         ontouchend="endLongPress(this, ${a.id}, '${dStr}')" 
                         ontouchcancel="cancelLongPress()"` : '';
                    
                    body += `<td class="day-cell ${isGreen?'p-partecipa':''} ${dStr===oggiStr?'today-cell':''}" 
                        ${longPressAttrs}
                        onclick="handleCellClick(event, this, ${a.id}, '${dStr}')">
                        ${hasNumber ? numberValue : (isGreen ? '‚úî' : '')}
                    </td>`;
                }
                body += `<td class="tot-cell">${totMese}</td></tr>`;
            });
            table.querySelector('tbody').innerHTML = body;
        });
    }

    // Funzione per abilitare/disabilitare l'input numerico
    function toggleNumericInput() {
        numericInputAttivo = !numericInputAttivo;
        const btn = document.getElementById('btn-numeric-input');
        const status = document.getElementById('status-auto');
        
        if (numericInputAttivo) {
            btn.innerHTML = "üî¢ NUM ON";
            btn.classList.add('attivo');
            status.innerText = "‚úÖ Input numerico ATTIVATO - Usa long press per inserire numeri";
            
            // Ricarica la tabella per aggiungere gli event listener
            renderTabella();
        } else {
            btn.innerHTML = "üî¢ NUM OFF";
            btn.classList.remove('attivo');
            status.innerText = "‚è∏Ô∏è Input numerico DISATTIVATO";
            
            // Ricarica la tabella per rimuovere gli event listener
            renderTabella();
        }
        
        // Salva lo stato nel localStorage per persistenza
        localStorage.setItem('numeric_input_attivo', numericInputAttivo);
    }

    // Carica lo stato dell'input numerico dal localStorage
    function caricaStatoNumericInput() {
        const savedState = localStorage.getItem('numeric_input_attivo');
        if (savedState !== null) {
            numericInputAttivo = savedState === 'true';
            const btn = document.getElementById('btn-numeric-input');
            if (numericInputAttivo) {
                btn.innerHTML = "üî¢ NUM ON";
                btn.classList.add('attivo');
            } else {
                btn.innerHTML = "üî¢ NUM OFF";
                btn.classList.remove('attivo');
            }
        }
    }

    // Gestione long press
    function startLongPress(el, aId, data) {
        // Esci se l'input numerico non √® attivo
        if (!numericInputAttivo) return;
        
        currentCellData = { el, aId, data };
        longPressTimer = setTimeout(() => {
            isLongPress = true;
            showNumberInput(el, aId, data);
        }, LONG_PRESS_DURATION);
    }

    function endLongPress() {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    }

    function cancelLongPress() {
        if (longPressTimer) {
            clearTimeout(longPressTimer);
            longPressTimer = null;
        }
    }

    function handleCellClick(event, el, aId, data) {
        event.preventDefault();
        event.stopPropagation();
        
        if (isScrolling) return;
        if (isLongPress) {
            isLongPress = false;
            return;
        }
        
        // Toggle normale presenza
        toggleCellState(el, aId, data);
    }

    async function toggleCellState(el, aId, data) {
        const currentText = el.innerText.trim();
        const p = presenzeCache.find(x => x.atleta_id === aId && x.data === data);
        
        // Se c'√® gi√† un numero, il click normale cancella tutto
        if (p && p.stato && p.stato.includes('numero:')) {
            await supabaseClient.from('presenze').delete().eq('atleta_id', aId).eq('data', data);
            el.classList.remove('p-partecipa');
            el.innerText = '';
        } else if (p && p.stato === 'partecipa') {
            // Se √® gi√† verde con ‚úî, diventa bianco
            await supabaseClient.from('presenze').delete().eq('atleta_id', aId).eq('data', data);
            el.classList.remove('p-partecipa');
            el.innerText = '';
        } else {
            // Altrimenti diventa verde con ‚úî
            await supabaseClient.from('presenze').upsert({ 
                atleta_id: aId, 
                data: data, 
                stato: 'partecipa' 
            }, { onConflict: 'atleta_id, data' });
            el.classList.add('p-partecipa');
            el.innerText = '‚úî';
        }
        
        // Aggiorna cache
        const idx = presenzeCache.findIndex(x => x.atleta_id === aId && x.data === data);
        if (el.classList.contains('p-partecipa')) {
            const stato = currentText && !['‚úî', ''].includes(currentText) ? `numero:${currentText}` : 'partecipa';
            if (idx > -1) {
                presenzeCache[idx].stato = stato;
            } else {
                presenzeCache.push({ atleta_id: aId, data: data, stato: stato });
            }
        } else if (idx > -1) {
            presenzeCache.splice(idx, 1);
        }
        
        updateTotalCell(el);
        
        // Avvia timer backup solo se √® attivo
        if (backupAutomaticoAttivo) {
            avviaTimerBackup();
        }
    }

    function showNumberInput(el, aId, data) {
        // Esci se l'input numerico non √® attivo
        if (!numericInputAttivo) return;
        
        currentCellData = { el, aId, data };
        
        // Controlla se c'√® gi√† un numero
        const p = presenzeCache.find(x => x.atleta_id === aId && x.data === data);
        let currentValue = '';
        if (p && p.stato && p.stato.includes('numero:')) {
            currentValue = p.stato.split(':')[1];
        }
        
        document.getElementById('number-input').value = currentValue;
        document.getElementById('number-input-overlay').style.display = 'flex';
        document.getElementById('number-input').focus();
        document.getElementById('number-input').select();
    }

    function clearNumberInput() {
        document.getElementById('number-input').value = '';
    }

    function cancelNumberInput() {
        document.getElementById('number-input-overlay').style.display = 'none';
        currentCellData = null;
    }

    async function confirmNumberInput() {
        const input = document.getElementById('number-input');
        const numberValue = input.value.trim();
        
        if (currentCellData && numberValue !== '') {
            const { el, aId, data } = currentCellData;
            
            // Salva il numero come "numero:VALORE" nello stato
            await supabaseClient.from('presenze').upsert({ 
                atleta_id: aId, 
                data: data, 
                stato: `numero:${numberValue}`
            }, { onConflict: 'atleta_id, data' });
            
            // Aggiorna visuale
            el.classList.add('p-partecipa');
            el.innerText = numberValue;
            
            // Aggiorna cache
            const idx = presenzeCache.findIndex(x => x.atleta_id === aId && x.data === data);
            if (idx > -1) {
                presenzeCache[idx].stato = `numero:${numberValue}`;
            } else {
                presenzeCache.push({ atleta_id: aId, data: data, stato: `numero:${numberValue}` });
            }
            
            updateTotalCell(el);
            
            // Avvia timer backup solo se √® attivo
            if (backupAutomaticoAttivo) {
                avviaTimerBackup();
            }
        }
        
        document.getElementById('number-input-overlay').style.display = 'none';
        currentCellData = null;
    }

    function updateTotalCell(el) {
        const row = el.parentElement;
        if (!row) return;
        
        const totCell = row.querySelector('.tot-cell');
        if (!totCell) return;
        
        let total = 0;
        const dayCells = row.querySelectorAll('.day-cell');
        dayCells.forEach(cell => {
            if (cell.classList.contains('p-partecipa')) {
                total++;
            }
        });
        
        totCell.innerText = total;
    }

    function avviaTimerBackup() {
        // Se il backup automatico √® disattivato, esci
        if (!backupAutomaticoAttivo) {
            return;
        }
        
        clearInterval(timerBackup); secondiMancanti = 10;
        const status = document.getElementById('status-auto');
        timerBackup = setInterval(() => { secondiMancanti--; status.innerText = `‚è≥ BACKUP IN ${secondiMancanti}s...`; if (secondiMancanti <= 0) { clearInterval(timerBackup); aggiornaBackupDrive(); } }, 1000);
    }

    // Funzione per gestire il toggle del backup automatico
    function toggleBackupAutomatico() {
        backupAutomaticoAttivo = !backupAutomaticoAttivo;
        const btn = document.getElementById('btn-backup-auto');
        const status = document.getElementById('status-auto');
        
        if (backupAutomaticoAttivo) {
            btn.innerHTML = "‚ñ∂Ô∏è AUTO ON";
            btn.classList.add('attivo');
            status.innerText = "‚úÖ Backup automatico ATTIVATO";
            
            // Se c'√® un timer in corso, resetta il conteggio
            if (secondiMancanti < 10 && timerBackup) {
                clearInterval(timerBackup);
                secondiMancanti = 10;
                status.innerText = "Sistema Pronto";
            }
        } else {
            btn.innerHTML = "‚è∏Ô∏è AUTO OFF";
            btn.classList.remove('attivo');
            status.innerText = "‚è∏Ô∏è Backup automatico DISATTIVATO";
            
            // Ferma il timer se √® in corso
            if (timerBackup) {
                clearInterval(timerBackup);
                timerBackup = null;
            }
        }
        
        // Salva lo stato nel localStorage per persistenza
        localStorage.setItem('backup_auto_attivo', backupAutomaticoAttivo);
    }

    async function aggiornaBackupDrive() {
        const status = document.getElementById('status-auto'); status.innerText = "‚òÅÔ∏è GENERANDO PDF...";
        try {
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF('l', 'mm', 'a4'); 
            const annoC = dataAttuale.getFullYear();
            
            for (let m = 0; m < 12; m++) {
                if (m > 0) doc.addPage();
                const g = new Date(annoC, m + 1, 0).getDate();
                const h = [["ATLETA", ...Array.from({length: g}, (_, i) => `${nomiGiorni[new Date(annoC, m, i + 1).getDay()]}\n${i + 1}`), "TOT"]];
                
                doc.setFontSize(14); 
                doc.setTextColor(52, 58, 64); 
                doc.text(`REGISTRO PRESENZE - ${nomiMesi[m].toUpperCase()} ${annoC}`, 14, 12);
                
                const colStyles = { 
                    0: { halign: 'left', cellWidth: 30, fontStyle: 'bold', fillColor: [255, 255, 255] } 
                };
                const larghezzaGiorno = (269 - 30 - 10) / g;
                for (let i = 1; i <= g; i++) colStyles[i] = { cellWidth: larghezzaGiorno };
                colStyles[g + 1] = { cellWidth: 8, fillColor: [248, 249, 250], fontStyle: 'bold' };

                const config = { 
                    head: h, 
                    startY: 18, 
                    theme: 'grid', 
                    tableWidth: 'wrap',
                    styles: { fontSize: 5, cellPadding: 0.5, halign: 'center', overflow: 'hidden', lineColor: [221, 221, 221] }, 
                    headStyles: { fillColor: [52, 58, 64], textColor: [255, 255, 255], fontStyle: 'bold', fontSize: 4.5 }, 
                    columnStyles: colStyles, 
                    didParseCell: function(data) { 
                        if (data.section === 'body' && data.column.index > 0 && data.column.index <= g && data.cell.text[0] !== '') { 
                            // Controlla se √® un numero
                            if (data.cell.text[0] !== '‚úî' && !isNaN(parseInt(data.cell.text[0]))) {
                                data.cell.styles.fillColor = [46, 204, 113]; // Verde per numeri
                                data.cell.styles.textColor = [255, 255, 255];
                            } else if (data.cell.text[0] === '‚úî') {
                                data.cell.styles.fillColor = [46, 204, 113]; // Verde per ‚úî
                                data.cell.styles.textColor = [255, 255, 255];
                            }
                        } 
                    } 
                };
                
                doc.autoTable({...config, body: preparaDatiPDF(CAT_CUCCIOLI, annoC, m, g)});
                doc.autoTable({...config, body: preparaDatiPDF(CAT_PICCOLI, annoC, m, g), startY: doc.lastAutoTable.finalY + 8});
                doc.autoTable({...config, body: preparaDatiPDF(CAT_GRANDI, annoC, m, g), startY: doc.lastAutoTable.finalY + 8});
            }
            
            const b64 = doc.output('datauristring').split(',')[1];
            status.innerText = "‚òÅÔ∏è SALVATAGGIO DRIVE...";
            const resp = await fetch(WEB_APP_DRIVE_URL, { method: 'POST', body: JSON.stringify({ nomeFile: `Registro_${annoC}.pdf`, blob: b64 }) });
            const res = await resp.json();
            if(res.fileUrl) { 
                localStorage.setItem('ultimo_pdf_url', res.fileUrl); 
                status.innerHTML = `‚úÖ BACKUP OK! <a href="${res.fileUrl}" target="_blank">APRI</a>`; 
            }
        } catch(e) { status.innerText = "‚ùå ERRORE BACKUP"; console.error(e); }
    }

    function preparaDatiPDF(cats, anno, mese, giorni) {
        return atletiCache.filter(a => {
            const inCat = cats.includes((a.categoria || "").trim().toUpperCase());
            if (!inCat) return false;
            if (a.archiviato === false || a.archiviato === null) return true;
            const dInizio = `${anno}-${String(mese+1).padStart(2,'0')}-01`, dFine = `${anno}-${String(mese+1).padStart(2,'0')}-${giorni}`;
            return presenzeCache.some(p => p.atleta_id === a.id && p.data >= dInizio && p.data <= dFine && (p.stato === 'partecipa' || p.stato.includes('numero:')));
        }).map(a => {
            let r = [a.nome.toUpperCase()], tot = 0;
            for(let d=1; d<=giorni; d++){
                let dStr = `${anno}-${String(mese+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const p = presenzeCache.find(x => x.atleta_id === a.id && x.data === dStr);
                if(p) {
                    if (p.stato === 'partecipa') {
                        r.push("‚úî");
                        tot++;
                    } else if (p.stato && p.stato.includes('numero:')) {
                        const num = p.stato.split(':')[1];
                        r.push(num);
                        tot++;
                    } else {
                        r.push("");
                    }
                } else {
                    r.push("");
                }
            }
            r.push(tot); return r;
        });
    }

    function scrollOggi() {
        const active = document.querySelector('.section-active'); if (!active) return;
        const target = active.querySelector('.today-cell'); const wrapper = active.querySelector('.table-wrapper');
        const stickyWidth = active.querySelector('.sticky-col').offsetWidth; 
        if (target && wrapper) wrapper.scrollTo({ left: target.offsetLeft - stickyWidth, behavior: 'smooth' });
    }

    function mostraSezione(s) {
        sessionStorage.setItem('last_sez', s); document.getElementById('main-menu').style.display = 'none';
        document.getElementById('sez-cuccioli').className = s === 'cuccioli' ? 'section-active' : 'section-container';
        document.getElementById('sez-piccoli').className = s === 'piccoli' ? 'section-active' : 'section-container';
        document.getElementById('sez-grandi').className = s === 'grandi' ? 'section-active' : 'section-container';
        setTimeout(scrollOggi, 300);
    }

    function vaiAllaHome() { sessionStorage.removeItem('last_sez'); location.reload(); }
    function cambiaData() { 
        localStorage.setItem('p_mese', document.getElementById('select-mese').value); 
        localStorage.setItem('p_anno', document.getElementById('select-anno').value); 
        location.reload(); 
    }
    function toggleAdmin() { const ov = document.getElementById('admin-overlay'); ov.style.display = ov.style.display === 'flex' ? 'none' : 'flex'; }
    function apriFileDrive() { const url = localStorage.getItem('ultimo_pdf_url'); if(url) window.open(url, '_blank'); else alert("Nessun backup trovato."); }

    async function salvaAtleta() {
        const id = document.getElementById('edit-id').value;
        const nome = document.getElementById('new-nome').value.trim().toUpperCase();
        const cat = document.getElementById('new-cat').value;
        if(nome) {
            document.getElementById('status-auto').innerText = "‚è≥ SALVATAGGIO...";
            let res;
            if(id) {
                res = await supabaseClient.from('atleti').update({ nome, categoria: cat }).eq('id', id);
            } else {
                res = await supabaseClient.from('atleti').insert([{ nome, categoria: cat, archiviato: false }]);
            }
            if (res.error) { 
                alert("Errore: " + res.error.message); 
                document.getElementById('status-auto').innerText = "‚ùå ERRORE";
            } else {
                resetForm(); await caricaDati();
                document.getElementById('status-auto').innerText = "‚úÖ SALVATO";
            }
        }
    }

    function preparaModifica(id, nome, cat) {
        document.getElementById('edit-id').value = id;
        document.getElementById('new-nome').value = nome;
        document.getElementById('new-cat').value = cat;
        document.getElementById('btn-save-atleta').innerText = "üíæ AGGIORNA ATLETA";
        document.getElementById('btn-cancel-edit').style.display = "block";
        document.getElementById('new-nome').focus();
    }

    function resetForm() {
        document.getElementById('edit-id').value = "";
        document.getElementById('new-nome').value = "";
        document.getElementById('new-cat').selectedIndex = 0;
        document.getElementById('btn-save-atleta').innerText = "+ AGGIUNGI ORA";
        document.getElementById('btn-cancel-edit').style.display = "none";
    }

    function renderAdminList() {
        document.getElementById('lista-atleti-admin').innerHTML = atletiCache.map(a => `
            <div class="atleta-item ${a.archiviato ? 'archiviato' : ''}">
                <div class="atleta-info">
                    <span class="atleta-name">${a.nome} ${a.archiviato ? '(ARCHIVIATO)' : ''}</span>
                    <span class="atleta-cat">${a.categoria}</span>
                </div>
                <div style="display:flex; gap:3px; flex-wrap:wrap; justify-content:flex-end;">
                    <button style="background:#4285F4; color:white; border:none; padding:6px 8px; border-radius:6px; font-weight:900; font-size:0.6rem;" 
                        onclick="preparaModifica(${a.id}, '${a.nome}', '${a.categoria}')">MODIFICA</button>
                    <button style="background:${a.archiviato ? '#34a853' : '#f39c12'}; color:white; border:none; padding:6px 8px; border-radius:6px; font-weight:900; font-size:0.6rem;" 
                        onclick="setArchiviazione(${a.id}, ${!a.archiviato})">${a.archiviato ? 'RIPRISTINA' : 'ARCHIVIA'}</button>
                    <button style="background:#ff4444; color:white; border:none; padding:6px 8px; border-radius:6px; font-weight:900; font-size:0.6rem;" 
                        onclick="eliminaDefinitivo(${a.id})">X</button>
                </div>
            </div>
        `).join('');
    }

    async function setArchiviazione(id, stato) {
        await supabaseClient.from('atleti').update({ archiviato: stato }).eq('id', id);
        await caricaDati();
    }

    async function eliminaDefinitivo(id) { 
        if(confirm("ATTENZIONE: Eliminando l'atleta sparir√† da TUTTI i PDF futuri (anche mesi passati). Sicuro?")) { 
            await supabaseClient.from('atleti').delete().eq('id', id); await caricaDati();
        } 
    }

    window.onload = inizializza;
    
    // Carica lo stato del backup automatico dal localStorage all'inizializzazione
    window.addEventListener('DOMContentLoaded', function() {
        const savedState = localStorage.getItem('backup_auto_attivo');
        if (savedState !== null) {
            backupAutomaticoAttivo = savedState === 'true';
            const btn = document.getElementById('btn-backup-auto');
            if (backupAutomaticoAttivo) {
                btn.innerHTML = "‚ñ∂Ô∏è AUTO ON";
                btn.classList.add('attivo');
            } else {
                btn.innerHTML = "‚è∏Ô∏è AUTO OFF";
                btn.classList.remove('attivo');
            }
        }
    });
</script>
</body>
</html>