<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Presenze 2050</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 5px; background: #eef2f7; color: #333; margin: 0; }
        .header { text-align: center; margin-bottom: 10px; }
        .logo { max-height: 80px; border-radius: 8px; margin-bottom: 5px; }
        h1 { font-size: 1.2rem; margin: 5px 0; }
        
        .controls-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex-wrap: wrap; }
        select, input { padding: 8px; border-radius: 6px; border: 1px solid #ccc; font-weight: bold; font-size: 0.9rem; }
        
        .actions-container { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .btn-action { padding: 10px 14px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; gap: 5px; font-size: 0.8rem; }
        .btn-pdf { background: #e74c3c; } .btn-drive { background: #4285F4; } .btn-open-drive { background: #34a853; } .btn-admin { background: #6c757d; } .btn-home { background: #ff9800; }
        .btn-oggi { background: #17a2b8; width: 45px; height: 45px; justify-content: center; font-size: 1.3rem; }
        
        /* TABELLA MASSIMIZZATA */
        .table-wrapper { overflow: auto; max-height: 75vh; border: 1px solid #ccc; border-radius: 8px; background: white; position: relative; -webkit-overflow-scrolling: touch; }
        table { border-collapse: separate; border-spacing: 0; width: 100%; }
        
        thead th { position: sticky; top: 0; background: #343a40 !important; color: white !important; z-index: 10; padding: 5px; font-size: 0.65rem; border: 1px solid #454d55; text-align: center; }
        
        /* COLONNA ATLETA FISSA E UNIFORME */
        .sticky-col-header { position: sticky; left: 0; background: #343a40 !important; color: white !important; z-index: 12; border-right: 2px solid #007bff; }
        .sticky-col { position: sticky; left: 0; background: white !important; color: #333 !important; z-index: 11; border-right: 2px solid #007bff; min-width: 130px; padding: 8px; font-weight: bold; text-align: left !important; white-space: nowrap; font-size: 0.85rem; }
        
        .day-cell { min-width: 45px; height: 45px; border: 1px solid #eee; text-align: center; cursor: pointer; font-weight: bold; font-size: 1rem; }
        .p-partecipa { background: #2ecc71 !important; color: white !important; }
        .today-cell { background: #d1ecf1; border: 2px solid #0c5460 !important; }
        .tot-cell { text-align: center; font-weight: bold; background: #f8f9fa; min-width: 40px; font-size: 0.9rem; }

        .menu-container { display: flex; gap: 10px; margin: 10px 0; }
        .btn-menu { flex: 1; padding: 25px 10px; font-weight: 900; font-size: 1.3rem; border-radius: 15px; color: white; border: none; cursor: pointer; text-transform: uppercase; }
        .btn-piccoli { background: #007bff; } .btn-grandi { background: #28a745; }
        .section-container { display: none; } .section-active { display: block; }
    </style>
</head>
<body>

    <div class="header">
        <img src="logo.png" alt="Logo" class="logo" onerror="this.src='https://via.placeholder.com/400x100?text=LOGO'">
        <div class="controls-container">
            <button class="btn-action btn-home" onclick="vaiAllaHome()">üè†</button>
            <select id="select-mese" onchange="cambiaData()"></select>
            <select id="select-anno" onchange="cambiaData()"></select>
            <button class="btn-action btn-oggi" onclick="scrollOggi()">üéØ</button>
        </div>
        <div class="actions-container">
            <button class="btn-action btn-pdf" onclick="esportaPDFLocale()">PDF</button>
            <button class="btn-action btn-drive" onclick="aggiornaBackupDrive()">‚òÅÔ∏è</button>
            <button class="btn-action btn-open-drive" onclick="apriFileDrive()">üìÇ</button>
            <button class="btn-action btn-admin" onclick="toggleAdmin()">‚öôÔ∏è</button>
        </div>
        <div id="status-auto" style="font-size:0.8rem;"></div>
    </div>

    <div id="admin-panel" style="display:none; padding:15px; background:white; border-radius:10px; margin-bottom:10px; border:1px solid #ccc;">
        <h3>Gestione Atleti</h3>
        <div style="display:flex; flex-direction:column; gap:5px;">
            <input type="text" id="new-nome" placeholder="Nome Atleta">
            <select id="new-cat">
                <option value="GIOVANISSIMI">GIOVANISSIMI</option><option value="ESORDIENTI">ESORDIENTI</option>
                <option value="R12">R12</option><option value="RAGAZZI">RAGAZZI</option><option value="ALLIEVI">ALLIEVI</option><option value="JUNIOR">JUNIOR</option><option value="SENIOR">SENIOR</option>
            </select>
            <button class="btn-action btn-open-drive" style="width:100%; justify-content:center" onclick="aggiungiAtleta()">SALVA</button>
        </div>
        <div id="lista-atleti-admin" style="margin-top:10px;"></div>
    </div>

    <div class="menu-container" id="main-menu">
        <button class="btn-menu btn-piccoli" onclick="mostraSezione('piccoli')">PICCOLI</button>
        <button class="btn-menu btn-grandi" onclick="mostraSezione('grandi')">GRANDI</button>
    </div>

    <div id="sez-piccoli" class="section-container">
        <div class="table-wrapper"><table id="tab-piccoli"><thead></thead><tbody></tbody></table></div>
    </div>
    <div id="sez-grandi" class="section-container">
        <div class="table-wrapper"><table id="tab-grandi"><thead></thead><tbody></tbody></table></div>
    </div>

<script>
    const SB_URL = 'https://jiktdsvwerqstrlthwxu.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imppa3Rkc3Z3ZXJxc3RybHRod3h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDkxMDEsImV4cCI6MjA4MzgyNTEwMX0.wmEnME6GaHXrvLoQH7MDijiTU4dZfoi9wOcrqs9fP10';
    const WEB_APP_DRIVE_URL = "https://script.google.com/macros/s/AKfycbz1P4-Eg-gCpsw9p_xrfrRqQJjJ0djEPSJcc1F6eIiHTaamTYFaBCqlnr12D-km3J5o/exec"; 

    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    let dataAttuale = new Date();
    let atletiCache = [], presenzeCache = [];
    const nomiMesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];
    const nomiGiorni = ["Dom", "Lun", "Mar", "Mer", "Gio", "Ven", "Sab"];
    const CAT_PICCOLI = ['GIOVANISSIMI', 'ESORDIENTI'];
    const CAT_GRANDI = ['R12', 'RAGAZZI', 'ALLIEVI', 'JUNIOR', 'JUNIORES', 'SENIOR', 'ALLIEVE'];

    async function inizializza() {
        const m = localStorage.getItem('p_mese') || dataAttuale.getMonth();
        const a = localStorage.getItem('p_anno') || dataAttuale.getFullYear();
        dataAttuale = new Date(a, m, 1);
        popolaSelettori(m, a);
        await caricaDati();
        const lastSez = sessionStorage.getItem('last_sez');
        if (lastSez) mostraSezione(lastSez);
    }

    function popolaSelettori(m, a) {
        const sm = document.getElementById('select-mese'), sa = document.getElementById('select-anno');
        nomiMesi.forEach((nome, i) => sm.add(new Option(nome, i)));
        for(let i=2025; i<=2050; i++) sa.add(new Option(i, i));
        sm.value = m; sa.value = a;
    }

    async function caricaDati() {
        const { data: atleti } = await supabaseClient.from('atleti').select('*').order('nome');
        atletiCache = atleti || [];
        const { data: presenze } = await supabaseClient.from('presenze').select('*')
            .gte('data', `${dataAttuale.getFullYear()}-01-01`)
            .lte('data', `${dataAttuale.getFullYear()}-12-31`);
        presenzeCache = presenze || [];
        renderTabella();
        renderAdminList();
    }

    function renderTabella() {
        const anno = dataAttuale.getFullYear(), mese = dataAttuale.getMonth();
        const giorniMese = new Date(anno, mese + 1, 0).getDate();
        const oggiStr = new Date().toLocaleDateString('en-CA');

        ["piccoli", "grandi"].forEach(tipo => {
            const table = document.getElementById(`tab-${tipo}`);
            let head = `<tr><th class="sticky-col-header sticky-col">ATLETA</th>`;
            for(let i=1; i<=giorniMese; i++) head += `<th>${nomiGiorni[new Date(anno, mese, i).getDay()]}<br>${i}</th>`;
            head += `<th>TOT</th></tr>`;
            table.querySelector('thead').innerHTML = head;

            const cats = tipo === 'piccoli' ? CAT_PICCOLI : CAT_GRANDI;
            const filtrati = atletiCache.filter(a => cats.includes((a.categoria || "").trim().toUpperCase()));
            let body = "";
            filtrati.forEach(a => {
                body += `<tr><td class="sticky-col">${a.nome.toUpperCase()}</td>`;
                let totMese = 0;
                for(let i=1; i<=giorniMese; i++) {
                    const dStr = `${anno}-${String(mese+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                    const p = presenzeCache.find(x => x.atleta_id === a.id && x.data === dStr && x.stato === 'partecipa');
                    if(p) totMese++;
                    body += `<td class="day-cell ${p?'p-partecipa':''} ${dStr===oggiStr?'today-cell':''}" onclick="togglePresenza(this, ${a.id}, '${dStr}')">${p?'‚úî':''}</td>`;
                }
                body += `<td class="tot-cell">${totMese}</td></tr>`;
            });
            table.querySelector('tbody').innerHTML = body;
        });
    }

    async function togglePresenza(el, aId, data) {
        const isP = el.classList.contains('p-partecipa');
        const nuovoStato = isP ? 'non partecipa' : 'partecipa';
        el.classList.toggle('p-partecipa'); el.innerText = isP ? '' : '‚úî';
        const totCell = el.parentElement.querySelector('.tot-cell');
        totCell.innerText = parseInt(totCell.innerText) + (nuovoStato === 'partecipa' ? 1 : -1);
        await supabaseClient.from('presenze').upsert({ atleta_id: aId, data: data, stato: nuovoStato }, { onConflict: 'atleta_id, data' });
    }

    function scrollOggi() {
        const active = document.querySelector('.section-active');
        if (!active) return;
        const target = active.querySelector('.today-cell');
        const wrapper = active.querySelector('.table-wrapper');
        const stickyWidth = active.querySelector('.sticky-col').offsetWidth; 
        
        if (target && wrapper) {
            // Posiziona il giorno corrente esattamente allineato al bordo della colonna atleta
            const scrollPos = target.offsetLeft - stickyWidth;
            wrapper.scrollTo({ left: scrollPos, behavior: 'smooth' });
        }
    }

    function mostraSezione(s) {
        sessionStorage.setItem('last_sez', s);
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('sez-piccoli').className = s === 'piccoli' ? 'section-active' : 'section-container';
        document.getElementById('sez-grandi').className = s === 'grandi' ? 'section-active' : 'section-container';
        setTimeout(scrollOggi, 300);
    }

    function vaiAllaHome() { sessionStorage.removeItem('last_sez'); location.reload(); }
    function cambiaData() {
        localStorage.setItem('p_mese', document.getElementById('select-mese').value);
        localStorage.setItem('p_anno', document.getElementById('select-anno').value);
        location.reload();
    }
    function toggleAdmin() { const p = document.getElementById('admin-panel'); p.style.display = p.style.display === 'block' ? 'none' : 'block'; }
    async function aggiungiAtleta() {
        const nome = document.getElementById('new-nome').value.trim(), cat = document.getElementById('new-cat').value;
        if(nome) { await supabaseClient.from('atleti').insert([{ nome, categoria: cat }]); location.reload(); }
    }
    function renderAdminList() {
        document.getElementById('lista-atleti-admin').innerHTML = atletiCache.map(a => `
            <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee;">
                <span>${a.nome}</span><button onclick="eliminaAtleta(${a.id})" style="color:red; border:none; background:none;">X</button>
            </div>`).join('');
    }
    async function eliminaAtleta(id) { if(confirm("Eliminare?")) { await supabaseClient.from('atleti').delete().eq('id', id); location.reload(); } }
    window.onload = inizializza;
</script>
</body>
</html>