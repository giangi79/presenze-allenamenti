<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Presenze 2025-2050</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', system-ui, sans-serif; padding: 15px; background: #eef2f7; color: #333; margin: 0; }
        .header { text-align: center; margin-bottom: 20px; position: relative; }
        .logo-container { margin-bottom: 15px; min-height: 100px; display: flex; align-items: center; justify-content: center; }
        .logo { max-width: 600px; max-height: 350px; width: auto; height: auto; border-radius: 12px; }
        
        .controls-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); flex-wrap: wrap; align-items: center; }
        select { padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; cursor: pointer; font-weight: 600; }
        
        .actions-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .btn-action { padding: 12px 20px; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; color: white; transition: 0.3s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-pdf { background: #e74c3c; }
        .btn-drive { background: #4285F4; }
        .btn-admin-toggle { background: #6c757d; }
        
        .btn-home { background: #ff9800; color: white; position: relative; min-width: 100px; }
        .btn-home.active-pulse::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.3); border-radius: 10px; animation: pulse 1.5s infinite;
        }
        @keyframes pulse { 0% { opacity: 0; transform: scale(1); } 50% { opacity: 1; } 100% { opacity: 0; transform: scale(1.05); } }

        .btn-oggi { background: #17a2b8; color: white; font-size: 1.5rem; width: 50px; height: 50px; padding: 0; display: flex; align-items: center; justify-content: center; line-height: 1; }
        .btn-oggi:active { transform: scale(1.1); }

        #status-auto { font-size: 1rem; color: #666; margin-top: 10px; font-weight: bold; min-height: 1.5rem; transition: 0.3s; }

        .table-wrapper { overflow: auto; max-height: 60vh; border: 2px solid #dee2e6; border-radius: 10px; background: white; scroll-behavior: smooth; }
        table { border-collapse: separate; border-spacing: 0; width: auto; }
        
        thead th { position: sticky; top: 0; background: #343a40 !important; color: white !important; z-index: 10; font-size: 0.8rem; border: 1px solid #454d55; height: 65px; min-width: 45px; text-align: center; }
        thead th.sticky-col { z-index: 15 !important; background: #343a40 !important; color: #ffffff !important; font-size: 1.1rem !important; font-weight: 900 !important; text-transform: uppercase; text-align: left; padding-left: 15px !important; }
        .sticky-col { position: sticky; left: 0; background-color: white !important; color: #000 !important; z-index: 5; border-right: 2px solid #007bff !important; width: 180px; min-width: 180px; text-align: left; padding: 8px 10px !important; font-weight: bold; }
        
        .day-cell { width: 45px; height: 45px; border: 1px solid #dee2e6; text-align: center; cursor: pointer; font-size: 1.1rem; font-weight: 700; }
        .p-partecipa { background: #2ecc71 !important; color: white !important; }
        .weekend-cell { background: #f1f3f5; }
        .today-cell { background-color: #d1ecf1; border: 2.5px solid #0c5460 !important; }

        @media (max-width: 600px) {
            body { padding: 8px; }
            .logo { max-height: 100px; max-width: 90%; }
            .logo-container { min-height: 100px; margin-bottom: 10px; }
            .btn-menu { padding: 35px 15px !important; font-size: 1.5rem !important; }
            .day-cell { width: 55px; height: 55px; font-size: 1.3rem; } 
            .sticky-col { width: 130px; min-width: 130px; font-size: 0.85rem; }
            .btn-action { flex: 1; padding: 12px 5px; font-size: 0.8rem; min-width: 80px; }
            .btn-home { min-width: 90px; }
            .btn-oggi { width: 50px; height: 50px; font-size: 1.8rem; flex: none; }
            .controls-container { gap: 8px; padding: 10px; }
            select { padding: 8px; font-size: 0.9rem; }
        }

        .menu-container { display: flex; gap: 15px; margin: 25px 0; }
        .btn-menu { flex: 1; padding: 25px; font-weight: 900; font-size: 1.3rem; border-radius: 18px; color: white; border: none; cursor: pointer; text-transform: uppercase; box-shadow: 0 6px rgba(0,0,0,0.2); }
        .btn-piccoli { background: #007bff; border-bottom: 6px solid #0056b3; }
        .btn-grandi { background: #28a745; border-bottom: 6px solid #1e7e34; }
        
        .section-container { display: none; background: white; border-radius: 15px; padding: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .section-active { display: block; }
        
        #admin-panel { background: #343a40; color: white; padding: 20px; border-radius: 15px; margin-top: 20px; display: none; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; margin-bottom: 20px; }
        .admin-grid input, .admin-grid select { padding: 12px; border-radius: 5px; border: none; color: black; font-size: 1rem; }
        .atleta-list-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #555; align-items: center; }

        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 10px; padding: 16px; position: fixed; z-index: 1000; left: 50%; bottom: 30px; transform: translateX(-50%); font-weight: bold; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo-container">
            <img src="logo.png" alt="Logo" class="logo" onerror="this.src='https://via.placeholder.com/600x200?text=LOGO'">
        </div>
        <h1>üìÖ Registro Presenze</h1>
        
        <div class="controls-container">
            <button id="btn-home" class="btn-action btn-home" onclick="vaiAllaHome()">üè† HOME</button>
            <select id="select-mese" onchange="cambiaData()"></select>
            <select id="select-anno" onchange="cambiaData()"></select>
            <button class="btn-action btn-oggi" onclick="scrollOggi()" title="Vai a Oggi">üéØ</button>
        </div>
        
        <div class="actions-container">
            <button class="btn-action btn-pdf" onclick="esportaPDFLocale()">üìÑ PDF MESE</button>
            <button class="btn-action btn-drive" id="btn-drive" onclick="aggiornaBackupDrive()">‚òÅÔ∏è PDF ANNO</button>
            <button class="btn-action btn-admin-toggle" onclick="toggleAdmin()">‚öôÔ∏è ADMIN</button>
        </div>
        <div id="status-auto">Sistema pronto</div>
    </div>

    <div id="admin-panel">
        <h3>Gestione Atleti</h3>
        <div class="admin-grid">
            <input type="text" id="new-atleta-nome" placeholder="Nome Atleta">
            <select id="new-atleta-cat">
                <option value="GIOVANISSIMI">GIOVANISSIMI</option>
                <option value="ESORDIENTI">ESORDIENTI</option>
                <option value="ALLIEVI">ALLIEVI</option>
                <option value="JUNIORES">JUNIORES</option>
            </select>
            <button class="btn-action btn-grandi" onclick="aggiungiAtleta()">AGGIUNGI</button>
        </div>
        <div id="lista-atleti-admin"></div>
    </div>

    <div class="menu-container" id="main-menu">
        <button class="btn-menu btn-piccoli" onclick="mostraSezione('piccoli')">PICCOLI</button>
        <button class="btn-menu btn-grandi" onclick="mostraSezione('grandi')">GRANDI</button>
    </div>

    <div id="sez-piccoli" class="section-container">
        <div class="table-wrapper" id="wrapper-piccoli"><table><thead id="head-piccoli"></thead><tbody id="body-piccoli"></tbody></table></div>
    </div>
    <div id="sez-grandi" class="section-container">
        <div class="table-wrapper" id="wrapper-grandi"><table><thead id="head-grandi"></thead><tbody id="body-grandi"></tbody></table></div>
    </div>

    <div id="toast"></div>

<script>
    const SB_URL = 'https://jiktdsvwerqstrlthwxu.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imppa3Rkc3Z3ZXJxc3RybHRod3h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDkxMDEsImV4cCI6MjA4MzgyNTEwMX0.wmEnME6GaHXrvLoQH7MDijiTU4dZfoi9wOcrqs9fP10';
    const WEB_APP_DRIVE_URL = "https://script.google.com/macros/s/AKfycbyuIMct3iRJaiI-6zg1J0tyzCOIjBcpVi_TmgivAd0dmInHxAf8vN8IzhX_F2UPTcR6nQ/exec";
    
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
    let dataAttuale = new Date(); 
    let atletiCache = [], presenzeCache = [];
    let autoSaveTimeout = null, countdownInterval = null;
    const nomiMesi = ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"];

    async function inizializza() {
        const ms = localStorage.getItem('presenze_mese') || dataAttuale.getMonth();
        const as = localStorage.getItem('presenze_anno') || dataAttuale.getFullYear();
        dataAttuale = new Date(as, ms, 1);
        
        popolaSelettori(); 
        document.getElementById('select-mese').value = ms;
        document.getElementById('select-anno').value = as;
        
        await caricaAtleti();
        const ultimaSezione = sessionStorage.getItem('ultima_sezione');
        if (ultimaSezione) mostraSezione(ultimaSezione);
    }

    async function caricaAtleti() {
        const { data: atleti } = await supabaseClient.from('atleti').select('*').order('nome');
        atletiCache = atleti || [];
        await caricaPresenze();
        aggiornaListaAdmin();
    }

    async function caricaPresenze() {
        const anno = dataAttuale.getFullYear(), mese = dataAttuale.getMonth();
        const giorniMese = new Date(anno, mese + 1, 0).getDate();
        const dI = `${anno}-${String(mese+1).padStart(2,'0')}-01`, dF = `${anno}-${String(mese+1).padStart(2,'0')}-${giorniMese}`;
        const { data: presenze } = await supabaseClient.from('presenze').select('*').gte('data', dI).lte('data', dF);
        presenzeCache = presenze || [];
        renderCalendari(anno, mese, giorniMese);
    }

    function renderCalendari(anno, mese, giorniMese) {
        const oggi = new Date(), isMeseCorrente = (oggi.getFullYear() == anno && oggi.getMonth() == mese), giornoOggi = oggi.getDate();
        const nomiG = ['D', 'L', 'M', 'M', 'G', 'V', 'S'];
        ['head-piccoli', 'head-grandi'].forEach(h => {
            let row = `<tr><th class="sticky-col">ATLETA</th>`;
            for(let i=1; i<=giorniMese; i++) {
                let dG = new Date(anno, mese, i), isToday = (isMeseCorrente && i == giornoOggi);
                row += `<th class="${isToday?'today-cell':''}" ${isToday?'id="today-marker"':''}><span>${nomiG[dG.getDay()]}</span><br>${i}</th>`;
            }
            row += `<th>TOT</th></tr>`;
            document.getElementById(h).innerHTML = row;
        });

        const bP = document.getElementById('body-piccoli'), bG = document.getElementById('body-grandi');
        bP.innerHTML = ""; bG.innerHTML = "";
        atletiCache.forEach(a => {
            let tr = document.createElement('tr'), count = 0;
            let html = `<td class="sticky-col"><b>${a.nome}</b></td>`;
            for(let d=1; d<=giorniMese; d++) {
                let dIso = `${anno}-${String(mese+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`, isW = (new Date(anno, mese, d).getDay()%6==0), isToday = (isMeseCorrente && d == giornoOggi);
                let p = presenzeCache.find(x => x.atleta_id == a.id && x.data == dIso && x.stato == "partecipa");
                if(p) count++;
                html += `<td class="day-cell ${p?'p-partecipa':''} ${isW?'weekend-cell':''} ${isToday?'today-cell':''}" onclick="cambiaStato(this, ${a.id}, '${dIso}')">${p?'‚úî':''}</td>`;
            }
            html += `<td style="text-align:center; font-weight:bold;" id="tot-${a.id}">${count}</td>`;
            tr.innerHTML = html;
            (a.categoria === 'GIOVANISSIMI' || a.categoria === 'ESORDIENTI' ? bP : bG).appendChild(tr);
        });
    }

    async function cambiaStato(el, aId, date) {
        let isP = el.classList.contains('p-partecipa'), nS = isP ? 'non partecipa' : 'partecipa';
        el.classList.toggle('p-partecipa'); el.innerText = isP ? "" : "‚úî";
        let totEl = document.getElementById(`tot-${aId}`);
        totEl.innerText = Math.max(0, parseInt(totEl.innerText) + (isP ? -1 : 1));
        await supabaseClient.from('presenze').upsert({ atleta_id: aId, data: date, stato: nS }, { onConflict: 'atleta_id, data' });
        pianificaSalvataggioDrive();
    }

    function pianificaSalvataggioDrive() {
        const s = document.getElementById('status-auto');
        let sec = 10;
        clearTimeout(autoSaveTimeout); clearInterval(countdownInterval);
        s.innerText = `‚è≥ Drive in ${sec}s...`; s.style.color = "#e67e22";
        countdownInterval = setInterval(() => { sec--; if(sec > 0) s.innerText = `‚è≥ Drive in ${sec}s...`; else clearInterval(countdownInterval); }, 1000);
        autoSaveTimeout = setTimeout(() => { aggiornaBackupDrive(true); }, 10000); 
    }

    async function aggiornaBackupDrive(isAuto = false) {
        const btn = document.getElementById('btn-drive'), s = document.getElementById('status-auto');
        if(!isAuto){ btn.innerText = "‚è≥ INVIO..."; btn.disabled = true; }
        
        try {
            const annoC = dataAttuale.getFullYear();
            const { data: pA } = await supabaseClient.from('presenze').select('*').gte('data', `${annoC}-01-01`).lte('data', `${annoC}-12-31`).eq('stato', 'partecipa');
            
            const payload = { 
                atleti: atletiCache, 
                presenze: pA || [], 
                anno: annoC,
                data_invio: new Date().toLocaleString()
            };

            await fetch(WEB_APP_DRIVE_URL, { method: 'POST', body: JSON.stringify(payload) });

            s.innerText = "‚úÖ Drive OK: " + new Date().toLocaleTimeString(); 
            s.style.color = "#27ae60";
            if(!isAuto) showToast("‚úÖ PDF ANNUALE AGGIORNATO!");
        } catch(e) { 
            s.innerText = "‚ùå Errore Drive"; 
            s.style.color = "#e74c3c"; 
        } finally { 
            if(!isAuto) { btn.innerText = "‚òÅÔ∏è PDF ANNO"; btn.disabled = false; } 
        }
    }

    function toggleAdmin() {
        const p = document.getElementById('admin-panel');
        p.style.display = (p.style.display === 'block') ? 'none' : 'block';
    }

    async function aggiungiAtleta() {
        const nome = document.getElementById('new-atleta-nome').value.toUpperCase();
        const cat = document.getElementById('new-atleta-cat').value;
        if (!nome) return;
        await supabaseClient.from('atleti').insert([{ nome, categoria: cat }]);
        document.getElementById('new-atleta-nome').value = "";
        await caricaAtleti();
    }

    async function eliminaAtleta(id) {
        if (!confirm("Eliminare definitivamente l'atleta?")) return;
        await supabaseClient.from('atleti').delete().eq('id', id);
        await caricaAtleti();
    }

    function aggiornaListaAdmin() {
        const container = document.getElementById('lista-atleti-admin');
        container.innerHTML = atletiCache.map(a => `
            <div class="atleta-list-item">
                <span>${a.nome} (${a.categoria})</span>
                <button onclick="eliminaAtleta(${a.id})" style="background:#e74c3c; color:white; border:none; padding:8px; border-radius:5px">ELIMINA</button>
            </div>
        `).join('');
    }

    function vaiAllaHome() {
        sessionStorage.removeItem('ultima_sezione');
        document.getElementById('sez-piccoli').classList.remove('section-active');
        document.getElementById('sez-grandi').classList.remove('section-active');
        document.getElementById('main-menu').style.display = 'flex';
        document.getElementById('btn-home').classList.remove('active-pulse');
        showToast("Home");
    }

    function cambiaData() {
        const m = document.getElementById('select-mese').value;
        const a = document.getElementById('select-anno').value;
        localStorage.setItem('presenze_mese', m);
        localStorage.setItem('presenze_anno', a);
        dataAttuale = new Date(a, m, 1);
        caricaPresenze();
    }

    function popolaSelettori() {
        const sm = document.getElementById('select-mese'), sa = document.getElementById('select-anno');
        sm.innerHTML = ""; sa.innerHTML = "";
        nomiMesi.forEach((m, i) => sm.add(new Option(m, i)));
        for(let a=2025; a<=2050; a++) sa.add(new Option(a, a));
    }

    function mostraSezione(t) {
        sessionStorage.setItem('ultima_sezione', t);
        document.getElementById('sez-piccoli').classList.toggle('section-active', t==='piccoli');
        document.getElementById('sez-grandi').classList.toggle('section-active', t==='grandi');
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('btn-home').classList.add('active-pulse');
        setTimeout(scrollOggi, 400);
    }

    function scrollOggi() {
        const marker = document.querySelector('.section-active #today-marker');
        const wrapper = document.querySelector('.section-active .table-wrapper');
        if (marker && wrapper) {
            const colonnaFissaWidth = window.innerWidth <= 600 ? 130 : 180;
            const viewportWidth = wrapper.clientWidth;
            const centerPoint = (viewportWidth - colonnaFissaWidth) / 2;
            const targetPos = marker.offsetLeft - colonnaFissaWidth - centerPoint + (marker.clientWidth / 2);
            wrapper.scrollTo({ left: targetPos, behavior: 'smooth' });
        }
    }

    function showToast(msg) {
        const t = document.getElementById("toast"); t.innerText = msg; t.className = "show";
        setTimeout(() => t.className = "", 3000);
    }

    async function esportaPDFLocale() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', 'a4');
        const anno = dataAttuale.getFullYear(), mIdx = dataAttuale.getMonth(), mNome = nomiMesi[mIdx], gM = new Date(anno, mIdx + 1, 0).getDate();
        const h = ["ATLETA", ...Array.from({length: gM}, (_, i) => i + 1), "TOT"];
        const creaDati = (tipo) => atletiCache.filter(a => tipo === 'piccoli' ? (a.categoria === 'GIOVANISSIMI' || a.categoria === 'ESORDIENTI') : (a.categoria !== 'GIOVANISSIMI' && a.categoria !== 'ESORDIENTI'))
            .map(a => {
                let row = [a.nome.toUpperCase()], tot = 0;
                for(let d=1; d<=gM; d++){
                    let dIso = `${anno}-${String(mIdx+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    let p = presenzeCache.find(x => x.atleta_id == a.id && x.data == dIso && x.stato == "partecipa");
                    if(p){ row.push("X"); tot++; } else row.push("");
                }
                row.push(tot); return row;
            });
        doc.text(`Presenze: ${mNome} ${anno}`, 14, 15);
        doc.autoTable({ head: [h], body: creaDati('piccoli'), startY: 25, theme: 'grid', styles: {fontSize: 6}});
        doc.autoTable({ head: [h], body: creaDati('grandi'), startY: doc.lastAutoTable.finalY + 10, theme: 'grid', styles: {fontSize: 6}});
        doc.save(`Presenze_${mNome}_${anno}.pdf`);
    }

    window.onload = inizializza;
</script>
</body>
</html>
