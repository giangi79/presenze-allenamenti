<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Gare Atleti</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f0f0f0; 
            margin: 0; 
            padding: 20px; 
        }
        .status-bar { 
            background: #333; 
            color: #fff; 
            padding: 10px; 
            margin-bottom: 20px; 
            border-radius: 5px; 
            font-size: 14px; 
            font-weight: bold; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background-color: white; 
            font-size: 14px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 10px; 
            text-align: left; 
        }
        th { 
            background-color: #4a6fa5; 
            color: white; 
        }
        .genere-f { 
            background-color: #ffb6c1; 
            text-align: center; 
            width: 30px; 
            font-weight: bold; 
            color: #333;
        }
        .genere-m { 
            background-color: #87ceeb; 
            text-align: center; 
            width: 30px; 
            font-weight: bold; 
            color: #333;
        }
        .checkbox-container { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            white-space: nowrap; 
        }
        input[type="checkbox"] { 
            transform: scale(1.3); 
            cursor: pointer; 
            margin-right: 5px;
        }
        input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        label {
            cursor: pointer;
        }
        .label-disabled {
            color: #999;
            cursor: not-allowed;
        }
        .separator { 
            background-color: #2c3e50 !important; 
            color: white; 
            font-weight: bold; 
            text-align: center; 
            letter-spacing: 2px; 
            padding: 12px;
            font-size: 16px;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f0f8ff;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .max-selected {
            color: #e74c3c;
            font-weight: bold;
        }
        .selection-count {
            font-size: 11px;
            color: #666;
            margin-left: 5px;
        }
    </style>
</head>
<body>

    <div id="debug-status" class="status-bar">Stato: Inizializzazione...</div>

    <table id="tabella-atleti">
        <thead>
            <tr>
                <th>COGNOME</th>
                <th>NOME</th>
                <th>CAT.</th>
                <th>G</th>
                <th>GARE (max 2)</th>
            </tr>
        </thead>
        <tbody id="body-atleti">
            <!-- I dati verranno inseriti qui dinamicamente -->
        </tbody>
    </table>

<script>
    // --- DATI ATLETI ORDINATI (CAT -> GENERE) ---
    const atletiData = [
        // SENIOR
        { type: 'sep', label: 'SENIOR' },
        { cognome: "BUCCOLINI", nome: "VALENTINA", cat: "SE", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "5000 m punti" },
        { cognome: "MARINELLI", nome: "EDOARDO", cat: "SE", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "5000 m punti" },
        
        // JUNIOR
        { type: 'sep', label: 'JUNIOR' },
        { cognome: "FRISOLI", nome: "ALESSIA", cat: "JU", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "5000 m punti" },
        
        // ALLIEVI
        { type: 'sep', label: 'ALLIEVI' },
        { cognome: "PETRUCCI", nome: "SARA", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "MARCOALDI", nome: "BENEDETTA", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "MILIOZZI", nome: "MATILDE", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "VIRGILI", nome: "EMMA", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "ROSSI", nome: "JAZMIN", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "NAPOLETANO", nome: "NOEMI", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "PANICHELLI", nome: "NICOLA", cat: "AL", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "MEZZADRI", nome: "ANDREA", cat: "AL", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "SDRUBOLINI", nome: "DAVIDE", cat: "AL", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        
        // RAGAZZI
        { type: 'sep', label: 'RAGAZZI' },
        { cognome: "ILLUMINATI", nome: "CHIARA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "BALDASSARRI", nome: "SUSANNA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "IDDA", nome: "AURORA ANGELICA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "MEDORI", nome: "ENRICA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "TORDINI", nome: "IRENE", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "EBAI", nome: "SOVIRA VIANA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "MENGHI", nome: "ALESSIA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "PANICHELLI", nome: "FLAVIA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "TRIBUZI", nome: "MARIA GIULIA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "ROMANO", nome: "DESIREE", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "BACCIFAVA", nome: "LEONARDO", cat: "RA", g: "M", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "CARDINI", nome: "EDOARDO", cat: "RA", g: "M", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "SANTUCCI", nome: "LORENZO", cat: "RA", g: "M", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        
        // R12
        { type: 'sep', label: 'R12' },
        { cognome: "FERRETTI", nome: "ELISA", cat: "R1", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "12 giri punti" },
        { cognome: "BARTOLINI", nome: "GLORIA", cat: "R1", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "12 giri punti" }
    ];

    const SUPABASE_URL = 'https://jiktdsvwerqstrlthwxu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imppa3Rkc3Z3ZXJxc3RybHRod3h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDkxMDEsImV4cCI6MjA4MzgyNTEwMX0.wmEnME6GaHXrvLoQH7MDijiTU4dZfoi9wOcrqs9fP10';

    // Variabili globali
    let supabaseClient = null;
    let realtimeSubscription = null;

    function logStatus(msg, color = "#333") {
        const el = document.getElementById('debug-status');
        el.innerText = "Stato: " + msg;
        el.style.backgroundColor = color;
        console.log("Status:", msg);
    }

    // Funzione per aggiornare lo stato dei checkbox per un atleta
    function updateCheckboxState(atletaRow) {
        const checkboxes = atletaRow.querySelectorAll('input[type="checkbox"]');
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        
        // Aggiorna contatore
        let counterElement = atletaRow.querySelector('.selection-count');
        if (!counterElement) {
            counterElement = document.createElement('span');
            counterElement.className = 'selection-count';
            atletaRow.querySelector('.checkbox-container').appendChild(counterElement);
        }
        counterElement.textContent = `(${selectedCount}/2)`;
        
        // Se 2 gare sono selezionate, disabilita le altre
        if (selectedCount >= 2) {
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.disabled = true;
                    cb.parentElement.classList.add('label-disabled');
                }
            });
            counterElement.classList.add('max-selected');
        } else {
            // Se meno di 2 gare sono selezionate, abilita tutte
            checkboxes.forEach(cb => {
                cb.disabled = false;
                cb.parentElement.classList.remove('label-disabled');
            });
            counterElement.classList.remove('max-selected');
        }
        
        return selectedCount;
    }

    function renderTable(initialData = []) {
        const tbody = document.getElementById('body-atleti');
        tbody.innerHTML = '';
        
        atletiData.forEach((item, index) => {
            if (item.type === 'sep') {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" class="separator">${item.label}</td>`;
                tbody.appendChild(tr);
            } else {
                const tr = document.createElement('tr');
                tr.dataset.atleta = `${item.cognome} ${item.nome}`;
                const fullName = `${item.cognome} ${item.nome}`;
                
                // Trova i dati salvati per questo atleta
                const savedData = initialData.find(r => r.atleta_nome === fullName);
                
                tr.innerHTML = `
                    <td>${item.cognome}</td>
                    <td>${item.nome}</td>
                    <td>${item.cat}</td>
                    <td class="${item.g === 'F' ? 'genere-f' : 'genere-m'}">${item.g}</td>
                    <td>
                        <div class="checkbox-container">
                            <label>
                                <input type="checkbox" 
                                       data-atleta="${fullName}"
                                       data-gara="gara_1" 
                                       ${savedData?.gara_1 ? 'checked' : ''}>
                                ${item.g1}
                            </label>
                            <label>
                                <input type="checkbox" 
                                       data-atleta="${fullName}"
                                       data-gara="gara_2" 
                                       ${savedData?.gara_2 ? 'checked' : ''}>
                                ${item.g2}
                            </label>
                            <label>
                                <input type="checkbox" 
                                       data-atleta="${fullName}"
                                       data-gara="gara_3" 
                                       ${savedData?.gara_3 ? 'checked' : ''}>
                                ${item.g3}
                            </label>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
                
                // Aggiorna lo stato dei checkbox dopo il rendering
                setTimeout(() => updateCheckboxState(tr), 0);
            }
        });
    }

    async function updateDb(atleta, field, value) {
        try {
            logStatus(`Aggiornamento: ${atleta} - ${field}: ${value}`, "#4a6fa5");
            
            const { data, error } = await supabaseClient
                .from('iscrizioni_gare')
                .upsert({
                    atleta_nome: atleta,
                    [field]: value
                }, {
                    onConflict: 'atleta_nome'
                });

            if (error) {
                throw error;
            }
            
            logStatus("Dati aggiornati con successo", "green");
        } catch (error) {
            console.error('Errore nell\'aggiornamento:', error);
            logStatus(`Errore: ${error.message}`, "red");
        }
    }

    function setupEventListeners() {
        document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', async function() {
                const atleta = this.dataset.atleta;
                const gara = this.dataset.gara;
                const isChecked = this.checked;
                
                // Trova la riga dell'atleta
                const atletaRow = this.closest('tr');
                
                // Controlla quante gare sono già selezionate
                const selectedCount = updateCheckboxState(atletaRow);
                
                // Se stai provando a selezionare una terza gara, impediscilo
                if (isChecked && selectedCount > 2) {
                    this.checked = false;
                    logStatus("Limite raggiunto: massimo 2 gare per atleta", "#e74c3c");
                    return;
                }
                
                // Se stai deselezionando una gara e ce ne sono 2 selezionate, abilita le altre
                if (!isChecked && selectedCount === 2) {
                    updateCheckboxState(atletaRow);
                }
                
                // Aggiorna il database solo se la selezione è valida
                if ((isChecked && selectedCount <= 2) || !isChecked) {
                    await updateDb(atleta, gara, isChecked);
                }
            });
        });
    }

    async function fetchInitialData() {
        try {
            const { data, error } = await supabaseClient
                .from('iscrizioni_gare')
                .select('*');

            if (error) {
                throw error;
            }

            logStatus("Dati iniziali caricati", "#4a6fa5");
            return data || [];
        } catch (error) {
            console.error('Errore nel caricamento dati:', error);
            logStatus(`Errore caricamento: ${error.message}`, "red");
            return [];
        }
    }

    function setupRealtimeSubscription() {
        if (realtimeSubscription) {
            supabaseClient.removeChannel(realtimeSubscription);
        }

        realtimeSubscription = supabaseClient
            .channel('iscrizioni-gare-changes')
            .on('postgres_changes', 
                { 
                    event: '*', 
                    schema: 'public', 
                    table: 'iscrizioni_gare' 
                }, 
                async (payload) => {
                    console.log('Cambio in tempo reale:', payload);
                    
                    // Ricarica i dati
                    const data = await fetchInitialData();
                    renderTable(data);
                    setupEventListeners();
                    
                    logStatus("Sincronizzato (Live)", "green");
                }
            )
            .subscribe();
    }

    window.onload = async () => {
        try {
            logStatus("Connessione a Supabase...", "#4a6fa5");
            
            // Inizializza Supabase
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Test connessione
            const { error: connError } = await supabaseClient
                .from('iscrizioni_gare')
                .select('count', { count: 'exact', head: true });
            
            if (connError) {
                throw new Error(`Errore connessione: ${connError.message}`);
            }

            // Carica dati iniziali
            const initialData = await fetchInitialData();
            
            // Renderizza tabella
            renderTable(initialData);
            
            // Setup event listeners
            setupEventListeners();
            
            // Setup realtime
            setupRealtimeSubscription();
            
            logStatus("Pronto - Max 2 gare per atleta", "green");
            
        } catch (error) {
            console.error('Errore iniziale:', error);
            logStatus(`Errore: ${error.message}`, "red");
            
            // Fallback: renderizza comunque la tabella senza dati
            renderTable();
            setupEventListeners();
        }
    };
</script>
</body>
</html>
