<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Gare Atleti</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f0f0f0; 
            margin: 0; 
            padding: 20px; 
        }
        .status-bar { 
            background: #333; 
            color: #fff; 
            padding: 10px; 
            margin-bottom: 20px; 
            border-radius: 5px; 
            font-size: 14px; 
            font-weight: bold; 
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            background-color: white; 
            font-size: 14px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 10px; 
            text-align: left; 
        }
        th { 
            background-color: #4a6fa5; 
            color: white; 
        }
        .genere-f { 
            background-color: #ffb6c1; 
            text-align: center; 
            width: 30px; 
            font-weight: bold; 
            color: #333;
        }
        .genere-m { 
            background-color: #87ceeb; 
            text-align: center; 
            width: 30px; 
            font-weight: bold; 
            color: #333;
        }
        .checkbox-container { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            white-space: nowrap; 
        }
        input[type="checkbox"] { 
            transform: scale(1.3); 
            cursor: pointer; 
            margin-right: 5px;
        }
        input[type="checkbox"]:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        input[type="number"] {
            width: 60px;
            padding: 5px;
            text-align: center;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        label {
            cursor: pointer;
        }
        .label-disabled {
            color: #999;
            cursor: not-allowed;
        }
        .separator { 
            background-color: #2c3e50 !important; 
            color: white; 
            font-weight: bold; 
            text-align: center; 
            letter-spacing: 2px; 
            padding: 12px;
            font-size: 16px;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f0f8ff;
        }
        .loading {
            opacity: 0.7;
            pointer-events: none;
        }
        .max-selected {
            color: #e74c3c;
            font-weight: bold;
        }
        .selection-count {
            font-size: 11px;
            color: #666;
            margin-left: 5px;
        }
        
        /* Stili per la sezione Americane */
        .americane-section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .americane-title {
            background-color: #2c3e50;
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            letter-spacing: 2px;
            margin-bottom: 20px;
            border-radius: 3px;
        }
        .categorie-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        .categoria-box {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background-color: #f9f9f9;
        }
        .categoria-header {
            background-color: #4a6fa5;
            color: white;
            padding: 8px 12px;
            margin: -15px -15px 15px -15px;
            border-radius: 5px 5px 0 0;
            font-weight: bold;
            text-align: center;
        }
        .genere-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .genere-row:last-child {
            border-bottom: none;
        }
        .genere-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }
        .genere-icon {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        .icon-f {
            background-color: #ffb6c1;
        }
        .icon-m {
            background-color: #87ceeb;
        }
        .number-input {
            width: 70px;
            padding: 6px 8px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            border: 2px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.3s;
        }
        .number-input:focus {
            outline: none;
            border-color: #4a6fa5;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }
        .totale-row {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 2px solid #4a6fa5;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }
        .save-button {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        .save-button:hover {
            background-color: #219653;
        }
        .save-button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <div id="debug-status" class="status-bar">Stato: Inizializzazione...</div>

    <table id="tabella-atleti">
        <thead>
            <tr>
                <th>COGNOME</th>
                <th>NOME</th>
                <th>CAT.</th>
                <th>G</th>
                <th>GARE (max 2)</th>
            </tr>
        </thead>
        <tbody id="body-atleti">
            <!-- I dati verranno inseriti qui dinamicamente -->
        </tbody>
    </table>

    <!-- Sezione Americane -->
    <div class="americane-section">
        <div class="americane-title">AMERICANE</div>
        
        <div class="categorie-container">
            <!-- RAGAZZI -->
            <div class="categoria-box">
                <div class="categoria-header">RAGAZZI</div>
                <div class="genere-row">
                    <div class="genere-label">
                        <span class="genere-icon icon-f">F</span>
                        Femmine
                    </div>
                    <input type="number" 
                           id="ragazzi-f" 
                           class="number-input" 
                           min="0" 
                           value="0"
                           data-categoria="ragazzi" 
                           data-genere="f">
                </div>
                <div class="genere-row">
                    <div class="genere-label">
                        <span class="genere-icon icon-m">M</span>
                        Maschi
                    </div>
                    <input type="number" 
                           id="ragazzi-m" 
                           class="number-input" 
                           min="0" 
                           value="0"
                           data-categoria="ragazzi" 
                           data-genere="m">
                </div>
                <div class="totale-row">
                    <span>Totale Ragazzi:</span>
                    <span id="totale-ragazzi">0</span>
                </div>
            </div>
            
            <!-- ALLIEVI -->
            <div class="categoria-box">
                <div class="categoria-header">ALLIEVI</div>
                <div class="genere-row">
                    <div class="genere-label">
                        <span class="genere-icon icon-f">F</span>
                        Femmine
                    </div>
                    <input type="number" 
                           id="allievi-f" 
                           class="number-input" 
                           min="0" 
                           value="0"
                           data-categoria="allievi" 
                           data-genere="f">
                </div>
                <div class="genere-row">
                    <div class="genere-label">
                        <span class="genere-icon icon-m">M</span>
                        Maschi
                    </div>
                    <input type="number" 
                           id="allievi-m" 
                           class="number-input" 
                           min="0" 
                           value="0"
                           data-categoria="allievi" 
                           data-genere="m">
                </div>
                <div class="totale-row">
                    <span>Totale Allievi:</span>
                    <span id="totale-allievi">0</span>
                </div>
            </div>
            
            <!-- SENIOR -->
            <div class="categoria-box">
                <div class="categoria-header">SENIOR</div>
                <div class="genere-row">
                    <div class="genere-label">
                        <span class="genere-icon icon-f">F</span>
                        Femmine
                    </div>
                    <input type="number" 
                           id="senior-f" 
                           class="number-input" 
                           min="0" 
                           value="0"
                           data-categoria="senior" 
                           data-genere="f">
                </div>
                <div class="genere-row">
                    <div class="genere-label">
                        <span class="genere-icon icon-m">M</span>
                        Maschi
                    </div>
                    <input type="number" 
                           id="senior-m" 
                           class="number-input" 
                           min="0" 
                           value="0"
                           data-categoria="senior" 
                           data-genere="m">
                </div>
                <div class="totale-row">
                    <span>Totale Senior:</span>
                    <span id="totale-senior">0</span>
                </div>
            </div>
        </div>
        
        <div class="totale-row" style="border-top: 2px solid #2c3e50; margin-top: 20px; padding-top: 15px; font-size: 16px;">
            <span>TOTALE GENERALE AMERICANE:</span>
            <span id="totale-generale-americane">0</span>
        </div>
        
        <button id="save-americane" class="save-button">Salva Dati Americane</button>
    </div>

<script>
    // --- DATI ATLETI ORDINATI (CAT -> GENERE) ---
    const atletiData = [
        // SENIOR
        { type: 'sep', label: 'SENIOR' },
        { cognome: "BUCCOLINI", nome: "VALENTINA", cat: "SE", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "5000 m punti" },
        { cognome: "MARINELLI", nome: "EDOARDO", cat: "SE", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "5000 m punti" },
        
        // JUNIOR
        { type: 'sep', label: 'JUNIOR' },
        { cognome: "FRISOLI", nome: "ALESSIA", cat: "JU", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "5000 m punti" },
        
        // ALLIEVI
        { type: 'sep', label: 'ALLIEVI' },
        { cognome: "PETRUCCI", nome: "SARA", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "MARCOALDI", nome: "BENEDETTA", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "MILIOZZI", nome: "MATILDE", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "VIRGILI", nome: "EMMA", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "NAPOLETANO", nome: "NOEMI", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "PANICHELLI", nome: "NICOLA", cat: "AL", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "MEZZADRI", nome: "ANDREA", cat: "AL", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "SDRUBOLINI", nome: "DAVIDE", cat: "AL", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        
        // RAGAZZI
        { type: 'sep', label: 'RAGAZZI' },
        { cognome: "ILLUMINATI", nome: "CHIARA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "BALDASSARRI", nome: "SUSANNA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "IDDA", nome: "AURORA ANGELICA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "MEDORI", nome: "ENRICA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "TORDINI", nome: "IRENE", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "EBAI", nome: "SOVIRA VIANA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "MENGHI", nome: "ALESSIA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "PANICHELLI", nome: "FLAVIA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "TRIBUZI", nome: "MARIA GIULIA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "ROMANO", nome: "DESIREE", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "BACCIFAVA", nome: "LEONARDO", cat: "RA", g: "M", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "CARDINI", nome: "EDOARDO", cat: "RA", g: "M", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "SANTUCCI", nome: "LORENZO", cat: "RA", g: "M", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        
        // R12
        { type: 'sep', label: 'R12' },
        { cognome: "FERRETTI", nome: "ELISA", cat: "R1", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "12 giri punti" },
        { cognome: "BARTOLINI", nome: "GLORIA", cat: "R1", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "12 giri punti" }
    ];

    const SUPABASE_URL = 'https://jiktdsvwerqstrlthwxu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imppa3Rkc3Z3ZXJxc3RybHRod3h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDkxMDEsImV4cCI6MjA4MzgyNTEwMX0.wmEnME6GaHXrvLoQH7MDijiTU4dZfoi9wOcrqs9fP10';

    // Variabili globali
    let supabaseClient = null;
    let realtimeSubscription = null;

    function logStatus(msg, color = "#333") {
        const el = document.getElementById('debug-status');
        el.innerText = "Stato: " + msg;
        el.style.backgroundColor = color;
        console.log("Status:", msg);
    }

    // Funzione per aggiornare lo stato dei checkbox per un atleta
    function updateCheckboxState(atletaRow) {
        const checkboxes = atletaRow.querySelectorAll('input[type="checkbox"]');
        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
        
        // Aggiorna contatore
        let counterElement = atletaRow.querySelector('.selection-count');
        if (!counterElement) {
            counterElement = document.createElement('span');
            counterElement.className = 'selection-count';
            atletaRow.querySelector('.checkbox-container').appendChild(counterElement);
        }
        counterElement.textContent = `(${selectedCount}/2)`;
        
        // Se 2 gare sono selezionate, disabilita le altre
        if (selectedCount >= 2) {
            checkboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.disabled = true;
                    cb.parentElement.classList.add('label-disabled');
                }
            });
            counterElement.classList.add('max-selected');
        } else {
            // Se meno di 2 gare sono selezionate, abilita tutte
            checkboxes.forEach(cb => {
                cb.disabled = false;
                cb.parentElement.classList.remove('label-disabled');
            });
            counterElement.classList.remove('max-selected');
        }
        
        return selectedCount;
    }

    // Funzione per calcolare e aggiornare i totali delle americane
    function updateAmericaneTotals() {
        // Calcola totali per categoria
        const ragazziF = parseInt(document.getElementById('ragazzi-f').value) || 0;
        const ragazziM = parseInt(document.getElementById('ragazzi-m').value) || 0;
        const totaleRagazzi = ragazziF + ragazziM;
        
        const allieviF = parseInt(document.getElementById('allievi-f').value) || 0;
        const allieviM = parseInt(document.getElementById('allievi-m').value) || 0;
        const totaleAllievi = allieviF + allieviM;
        
        const seniorF = parseInt(document.getElementById('senior-f').value) || 0;
        const seniorM = parseInt(document.getElementById('senior-m').value) || 0;
        const totaleSenior = seniorF + seniorM;
        
        // Calcola totale generale
        const totaleGenerale = totaleRagazzi + totaleAllievi + totaleSenior;
        
        // Aggiorna i totali visualizzati
        document.getElementById('totale-ragazzi').textContent = totaleRagazzi;
        document.getElementById('totale-allievi').textContent = totaleAllievi;
        document.getElementById('totale-senior').textContent = totaleSenior;
        document.getElementById('totale-generale-americane').textContent = totaleGenerale;
        
        return {
            ragazzi: { f: ragazziF, m: ragazziM, totale: totaleRagazzi },
            allievi: { f: allieviF, m: allieviM, totale: totaleAllievi },
            senior: { f: seniorF, m: seniorM, totale: totaleSenior },
            generale: totaleGenerale
        };
    }

    function renderTable(initialData = []) {
        const tbody = document.getElementById('body-atleti');
        tbody.innerHTML = '';
        
        atletiData.forEach((item, index) => {
            if (item.type === 'sep') {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" class="separator">${item.label}</td>`;
                tbody.appendChild(tr);
            } else {
                const tr = document.createElement('tr');
                tr.dataset.atleta = `${item.cognome} ${item.nome}`;
                const fullName = `${item.cognome} ${item.nome}`;
                
                // Trova i dati salvati per questo atleta
                const savedData = initialData.find(r => r.atleta_nome === fullName);
                
                tr.innerHTML = `
                    <td>${item.cognome}</td>
                    <td>${item.nome}</td>
                    <td>${item.cat}</td>
                    <td class="${item.g === 'F' ? 'genere-f' : 'genere-m'}">${item.g}</td>
                    <td>
                        <div class="checkbox-container">
                            <label>
                                <input type="checkbox" 
                                       data-atleta="${fullName}"
                                       data-gara="gara_1" 
                                       ${savedData?.gara_1 ? 'checked' : ''}>
                                ${item.g1}
                            </label>
                            <label>
                                <input type="checkbox" 
                                       data-atleta="${fullName}"
                                       data-gara="gara_2" 
                                       ${savedData?.gara_2 ? 'checked' : ''}>
                                ${item.g2}
                            </label>
                            <label>
                                <input type="checkbox" 
                                       data-atleta="${fullName}"
                                       data-gara="gara_3" 
                                       ${savedData?.gara_3 ? 'checked' : ''}>
                                ${item.g3}
                            </label>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
                
                // Aggiorna lo stato dei checkbox dopo il rendering
                setTimeout(() => updateCheckboxState(tr), 0);
            }
        });
    }

    async function updateDb(atleta, field, value) {
        try {
            logStatus(`Aggiornamento: ${atleta} - ${field}: ${value}`, "#4a6fa5");
            
            const { data, error } = await supabaseClient
                .from('iscrizioni_gare')
                .upsert({
                    atleta_nome: atleta,
                    [field]: value
                }, {
                    onConflict: 'atleta_nome'
                });

            if (error) {
                throw error;
            }
            
            logStatus("Dati aggiornati con successo", "green");
        } catch (error) {
            console.error('Errore nell\'aggiornamento:', error);
            logStatus(`Errore: ${error.message}`, "red");
        }
    }

    async function saveAmericaneData() {
        try {
            const americaneData = updateAmericaneTotals();
            
            logStatus("Salvataggio dati americane...", "#4a6fa5");
            
            const { data, error } = await supabaseClient
                .from('americane')
                .upsert({
                    id: 1, // ID fisso per i dati delle americane
                    data: americaneData,
                    updated_at: new Date().toISOString()
                }, {
                    onConflict: 'id'
                });

            if (error) {
                throw error;
            }
            
            logStatus("Dati americane salvati con successo", "#27ae60");
            
            // Mostra conferma temporanea
            const saveButton = document.getElementById('save-americane');
            const originalText = saveButton.textContent;
            saveButton.textContent = "✓ Salvato!";
            saveButton.style.backgroundColor = "#27ae60";
            
            setTimeout(() => {
                saveButton.textContent = originalText;
                saveButton.style.backgroundColor = "";
            }, 2000);
            
        } catch (error) {
            console.error('Errore nel salvataggio dati americane:', error);
            logStatus(`Errore salvataggio americane: ${error.message}`, "red");
        }
    }

    async function loadAmericaneData() {
        try {
            const { data, error } = await supabaseClient
                .from('americane')
                .select('*')
                .eq('id', 1)
                .single();

            if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
                throw error;
            }

            if (data && data.data) {
                const americaneData = data.data;
                
                // Imposta i valori nei campi
                if (americaneData.ragazzi) {
                    document.getElementById('ragazzi-f').value = americaneData.ragazzi.f || 0;
                    document.getElementById('ragazzi-m').value = americaneData.ragazzi.m || 0;
                }
                if (americaneData.allievi) {
                    document.getElementById('allievi-f').value = americaneData.allievi.f || 0;
                    document.getElementById('allievi-m').value = americaneData.allievi.m || 0;
                }
                if (americaneData.senior) {
                    document.getElementById('senior-f').value = americaneData.senior.f || 0;
                    document.getElementById('senior-m').value = americaneData.senior.m || 0;
                }
                
                // Aggiorna i totali
                updateAmericaneTotals();
                
                logStatus("Dati americane caricati", "#4a6fa5");
            }
        } catch (error) {
            console.error('Errore nel caricamento dati americane:', error);
            // Non mostriamo errore se non ci sono dati salvati
        }
    }

    function setupEventListeners() {
        // Event listeners per i checkbox delle gare
        document.querySelectorAll('#tabella-atleti input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', async function() {
                const atleta = this.dataset.atleta;
                const gara = this.dataset.gara;
                const isChecked = this.checked;
                
                // Trova la riga dell'atleta
                const atletaRow = this.closest('tr');
                
                // Controlla quante gare sono già selezionate
                const selectedCount = updateCheckboxState(atletaRow);
                
                // Se stai provando a selezionare una terza gara, impediscilo
                if (isChecked && selectedCount > 2) {
                    this.checked = false;
                    logStatus("Limite raggiunto: massimo 2 gare per atleta", "#e74c3c");
                    return;
                }
                
                // Se stai deselezionando una gara e ce ne sono 2 selezionate, abilita le altre
                if (!isChecked && selectedCount === 2) {
                    updateCheckboxState(atletaRow);
                }
                
                // Aggiorna il database solo se la selezione è valida
                if ((isChecked && selectedCount <= 2) || !isChecked) {
                    await updateDb(atleta, gara, isChecked);
                }
            });
        });
        
        // Event listeners per i campi delle americane
        document.querySelectorAll('.number-input').forEach(input => {
            input.addEventListener('input', function() {
                // Assicura che il valore non sia negativo
                if (this.value < 0) this.value = 0;
                // Aggiorna i totali in tempo reale
                updateAmericaneTotals();
            });
            
            input.addEventListener('change', function() {
                // Salva automaticamente quando l'utente modifica un valore
                saveAmericaneData();
            });
        });
        
        // Event listener per il pulsante di salvataggio
        document.getElementById('save-americane').addEventListener('click', saveAmericaneData);
    }

    async function fetchInitialData() {
        try {
            const { data, error } = await supabaseClient
                .from('iscrizioni_gare')
                .select('*');

            if (error) {
                throw error;
            }

            logStatus("Dati iniziali caricati", "#4a6fa5");
            return data || [];
        } catch (error) {
            console.error('Errore nel caricamento dati:', error);
            logStatus(`Errore caricamento: ${error.message}`, "red");
            return [];
        }
    }

    function setupRealtimeSubscription() {
        if (realtimeSubscription) {
            supabaseClient.removeChannel(realtimeSubscription);
        }

        realtimeSubscription = supabaseClient
            .channel('iscrizioni-gare-changes')
            .on('postgres_changes', 
                { 
                    event: '*', 
                    schema: 'public', 
                    table: 'iscrizioni_gare' 
                }, 
                async (payload) => {
                    console.log('Cambio in tempo reale:', payload);
                    
                    // Ricarica i dati
                    const data = await fetchInitialData();
                    renderTable(data);
                    setupEventListeners();
                    
                    logStatus("Sincronizzato (Live)", "green");
                }
            )
            .subscribe();
    }

    window.onload = async () => {
        try {
            logStatus("Connessione a Supabase...", "#4a6fa5");
            
            // Inizializza Supabase
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Test connessione
            const { error: connError } = await supabaseClient
                .from('iscrizioni_gare')
                .select('count', { count: 'exact', head: true });
            
            if (connError) {
                throw new Error(`Errore connessione: ${connError.message}`);
            }

            // Carica dati iniziali delle gare
            const initialData = await fetchInitialData();
            
            // Carica dati americane
            await loadAmericaneData();
            
            // Renderizza tabella
            renderTable(initialData);
            
            // Setup event listeners
            setupEventListeners();
            
            // Setup realtime per le gare
            setupRealtimeSubscription();
            
            // Setup realtime anche per le americane
            supabaseClient
                .channel('americane-changes')
                .on('postgres_changes', 
                    { 
                        event: '*', 
                        schema: 'public', 
                        table: 'americane' 
                    }, 
                    async () => {
                        await loadAmericaneData();
                        logStatus("Americane sincronizzate (Live)", "green");
                    }
                )
                .subscribe();
            
            logStatus("Pronto - Max 2 gare per atleta", "green");
            
        } catch (error) {
            console.error('Errore iniziale:', error);
            logStatus(`Errore: ${error.message}`, "red");
            
            // Fallback: renderizza comunque la tabella senza dati
            renderTable();
            setupEventListeners();
        }
    };
</script>
</body>
</html>
