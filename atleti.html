<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Gare Atleti</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; margin: 0; padding: 10px; }
        .status-bar { background: #333; color: #fff; padding: 10px; margin-bottom: 10px; border-radius: 5px; font-size: 13px; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; background-color: #add8e6; font-size: 14px; }
        th, td { border: 1px solid #777; padding: 6px; text-align: left; }
        th { background-color: #ccc; }
        .genere-f { background-color: #ff6666; text-align: center; width: 30px; font-weight: bold; }
        .genere-m { background-color: #6666ff; text-align: center; width: 30px; font-weight: bold; }
        .checkbox-container { display: flex; align-items: center; gap: 5px; white-space: nowrap; }
        input[type="checkbox"] { transform: scale(1.3); cursor: pointer; }
        /* Riga separatore categoria */
        .separator { background-color: #555 !important; color: white; font-weight: bold; text-align: center; letter-spacing: 2px; }
    </style>
</head>
<body>

    <div id="debug-status" class="status-bar">Stato: Avvio script...</div>

    <table id="tabella-atleti">
        <thead>
            <tr>
                <th>COGNOME</th>
                <th>NOME</th>
                <th>CAT.</th>
                <th>G</th>
                <th>GARE</th>
            </tr>
        </thead>
        <tbody id="body-atleti">
            </tbody>
    </table>

<script>
    // --- DATI ATLETI ORDINATI (CAT -> GENERE) ---
    const atletiData = [
        // SENIOR
        { type: 'sep', label: 'SENIOR' },
        { cognome: "BUCCOLINI", nome: "VALENTINA", cat: "SE", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "5000 m punti" },
        { cognome: "MARINELLI", nome: "EDOARDO", cat: "SE", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "5000 m punti" },
        
        // JUNIOR
        { type: 'sep', label: 'JUNIOR' },
        { cognome: "FRISOLI", nome: "ALESSIA", cat: "JU", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "5000 m punti" },
        
        // ALLIEVI
        { type: 'sep', label: 'ALLIEVI' },
        { cognome: "PETRUCCI", nome: "SARA", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "MARCOALDI", nome: "BENEDETTA", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "MILIOZZI", nome: "MATILDE", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "VIRGILI", nome: "EMMA", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "ROSSI", nome: "JAZMIN", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "NAPOLETANO", nome: "NOEMI", cat: "AL", g: "F", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "PANICHELLI", nome: "NICOLA", cat: "AL", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "MEZZADRI", nome: "ANDREA", cat: "AL", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        { cognome: "SDRUBOLINI", nome: "DAVIDE", cat: "AL", g: "M", g1: "1 giri Crono", g2: "1000 m Sprint", g3: "3000 m punti" },
        
        // RAGAZZI
        { type: 'sep', label: 'RAGAZZI' },
        { cognome: "ILLUMINATI", nome: "CHIARA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "BALDASSARRI", nome: "SUSANNA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "IDDA", nome: "AURORA ANGELICA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "MEDORI", nome: "ENRICA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "TORDINI", nome: "IRENE", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "EBAI", nome: "SOVIRA VIANA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "MENGHI", nome: "ALESSIA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "PANICHELLI", nome: "FLAVIA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "TRIBUZI", nome: "MARIA GIULIA", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "ROMANO", nome: "DESIREE", cat: "RA", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "BACCIFAVA", nome: "LEONARDO", cat: "RA", g: "M", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "CARDINI", nome: "EDOARDO", cat: "RA", g: "M", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        { cognome: "SANTUCCI", nome: "LORENZO", cat: "RA", g: "M", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "3000 m punti" },
        
        // R12
        { type: 'sep', label: 'R12' },
        { cognome: "FERRETTI", nome: "ELISA", cat: "R1", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "12 giri punti" },
        { cognome: "BARTOLINI", nome: "GLORIA", cat: "R1", g: "F", g1: "1 giri Crono", g2: "1 giri Sprint", g3: "12 giri punti" }
    ];

    const SUPABASE_URL = 'https://jiktdsvwerqstrlthwxu.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imppa3Rkc3Z3ZXJxc3RybHRod3h1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyNDkxMDEsImV4cCI6MjA4MzgyNTEwMX0.wmEnME6GaHXrvLoQH7MDijiTU4dZfoi9wOcrqs9fP10';

    function logStatus(msg, color = "#333") {
        const el = document.getElementById('debug-status');
        el.innerText = "Stato: " + msg;
        el.style.backgroundColor = color;
    }

    function renderTable() {
        const tbody = document.getElementById('body-atleti');
        tbody.innerHTML = '';
        
        atletiData.forEach((item, index) => {
            if (item.type === 'sep') {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" class="separator">${item.label}</td>`;
                tbody.appendChild(tr);
            } else {
                const tr = document.createElement('tr');
                const fullName = `${item.cognome} ${item.nome}`;
                tr.innerHTML = `
                    <td>${item.cognome}</td>
                    <td>${item.nome}</td>
                    <td>${item.cat}</td>
                    <td class="${item.g === 'F' ? 'genere-f' : 'genere-m'}">${item.g}</td>
                    <td>
                        <div class="checkbox-container">
                            <label><input type="checkbox" id="g1-${index}" onchange="updateDb('${fullName}', 'gara_1', this.checked)"> ${item.g1}</label> |
                            <label><input type="checkbox" id="g2-${index}" onchange="updateDb('${fullName}', 'gara_2', this.checked)"> ${item.g2}</label> |
                            <label><input type="checkbox" id="g3-${index}" onchange="updateDb('${fullName}', 'gara_3', this.checked)"> ${item.g3}</label>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            }
        });
    }

    window.onload = async () => {
        renderTable();
        const sbClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        window.updateDb = async (atleta, field, value) => {
            await sbClient.from('iscrizioni_gare').upsert({ atleta_nome: atleta, [field]: value }, { onConflict: 'atleta_nome' });
        };

        async function fetchData() {
            const { data, error } = await sbClient.from('iscrizioni_gare').select('*');
            if (!error && data) {
                logStatus("Sincronizzato (Live)", "green");
                data.forEach(row => {
                    // Troviamo l'indice corretto saltando i separatori
                    const idx = atletiData.findIndex(a => a.type !== 'sep' && `${a.cognome} ${a.nome}` === row.atleta_nome);
                    if (idx !== -1) {
                        if (document.getElementById(`g1-${idx}`)) document.getElementById(`g1-${idx}`).checked = row.gara_1;
                        if (document.getElementById(`g2-${idx}`)) document.getElementById(`g2-${idx}`).checked = row.gara_2;
                        if (document.getElementById(`g3-${idx}`)) document.getElementById(`g3-${idx}`).checked = row.gara_3;
                    }
                });
            }
        }

        sbClient.channel('any').on('postgres_changes', { event: '*', schema: 'public', table: 'iscrizioni_gare' }, fetchData).subscribe();
        fetchData();
    };
</script>
</body>
</html>